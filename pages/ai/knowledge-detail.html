<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库详情 - iClass智慧课堂</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <style>
        /* Custom scrollbar */
        .table-container::-webkit-scrollbar,
        body::-webkit-scrollbar {
            height: 10px;
            width: 10px;
        }
        .table-container::-webkit-scrollbar-track,
        body::-webkit-scrollbar-track {
            background: #f8fafc;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-thumb,
        body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
            border: 2px solid #f8fafc;
        }
        .table-container::-webkit-scrollbar-thumb:hover,
        body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Tab Active State */
        .tab-btn.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
        
        /* Form Focus Ring */
        .form-input:focus {
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col font-sans text-gray-700 overflow-hidden">

    <!-- Header / Breadcrumb / Tabs -->
    <div class="bg-white shadow-sm border-b border-gray-200 px-6 pt-4 shrink-0 z-20">
        <!-- Breadcrumb & Title -->
        <div class="flex items-center gap-2 text-sm text-gray-500 mb-4">
            <a href="knowledge.html" onclick="return handleBackToList()" class="hover:text-blue-600 transition-colors flex items-center gap-1">
                <i class="fas fa-arrow-left"></i> 返回知识库列表
            </a>
            <span class="text-gray-300">|</span> 
            <span class="font-bold text-gray-800 text-base" id="kb-title">数字电视系统</span>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-8">
            <button onclick="switchTab('management')" id="tab-management" class="tab-btn active pb-3 px-1 text-sm font-bold text-gray-600 border-b-2 border-transparent hover:text-blue-600 transition-all">
                知识点管理
            </button>
            <button onclick="switchTab('attachment')" id="tab-attachment" class="tab-btn pb-3 px-1 text-sm font-bold text-gray-600 border-b-2 border-transparent hover:text-blue-600 transition-all">
                知识点附件
            </button>
            <button onclick="switchTab('config')" id="tab-config" class="tab-btn pb-3 px-1 text-sm font-bold text-gray-600 border-b-2 border-transparent hover:text-blue-600 transition-all">
                知识库配置
            </button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 p-4 overflow-hidden relative">
        
        <!-- Tab 1: Knowledge Point Management -->
        <div id="view-management" class="bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col p-4 animate-fade-in">
            <!-- Filter Section -->
            <div class="flex flex-wrap items-center justify-between mb-4 shrink-0">
                <div class="flex items-center gap-3">
                    <!-- Custom Dropdown -->
                    <div class="relative w-32" id="kp-status-dropdown">
                        <button id="kp-status-select-btn" class="flex items-center justify-between w-full bg-white border border-gray-300 text-gray-700 py-2 pl-3 pr-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition-shadow shadow-sm hover:border-gray-400">
                            <span id="kp-status-select-text" class="text-gray-700">全部</span>
                            <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform duration-200" id="kp-status-select-icon"></i>
                        </button>
                        <div id="kp-status-options" class="hidden absolute top-full left-0 mt-1 w-full bg-white border border-gray-100 rounded-lg shadow-lg z-50 py-1 transform origin-top transition-all duration-200 opacity-0 scale-95">
                            <!-- Options generated by JS -->
                        </div>
                    </div>
                    <div class="relative">
                        <input id="kp-search-input" type="text" placeholder="搜索文件" class="bg-white border border-gray-300 text-gray-700 py-2 pl-3 pr-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 text-sm">
                    </div>
                    <button id="kp-search-btn" onclick="handleSearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-5 rounded-lg text-sm transition-all shadow-sm">
                        查询
                    </button>
                    <button id="kp-reset-btn" onclick="handleReset()" class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 font-medium py-2 px-5 rounded-lg text-sm transition-all shadow-sm">
                        重置
                    </button>
                </div>
                <button onclick="openUploadModal()" class="flex items-center bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-lg text-sm transition-all shadow-sm">
                    <i class="fas fa-plus mr-2"></i>上传文件
                </button>
            </div>

            <!-- Table -->
            <div class="table-container flex-1 border border-gray-200 rounded-lg relative overflow-auto">
                <table class="min-w-max w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50/90 backdrop-blur-sm shadow-sm relative z-40">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-center w-12 sticky top-0 left-0 z-30 bg-gray-50">
                                <input type="checkbox" id="kp-select-all-header" onchange="toggleSelectAll(this.checked)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4 cursor-pointer">
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider sticky top-0 left-12 z-30 bg-gray-50 shadow-[5px_0_5px_-5px_rgba(0,0,0,0.1)]">名称</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider sticky top-0 z-20 bg-gray-50">分块数</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider sticky top-0 z-20 bg-gray-50">修改日期</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider sticky top-0 z-20 bg-gray-50">切片方法</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider sticky top-0 z-20 bg-gray-50">启用状态</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-32 sticky top-0 z-20 bg-gray-50">解析状态</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider w-24 sticky top-0 right-0 bg-gray-50 z-30 shadow-[-5px_0_5px_-5px_rgba(0,0,0,0.1)]">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm" id="kp-table-body">
                        <!-- JS Populated -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="kp-pagination" class="flex flex-wrap items-center justify-between pt-3 mt-auto shrink-0">
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" id="kp-select-all-footer" onchange="toggleSelectAll(this.checked)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4">
                        全选
                    </label>
                    <button class="text-gray-600 hover:text-blue-600 text-sm font-medium transition-colors">
                        批量下载
                    </button>
                    <div id="kp-total-count" class="text-sm text-gray-600 font-medium ml-4">
                        共 0 条
                    </div>
                </div>
                
                <div id="kp-pagination-controls" class="flex items-center space-x-3">
                    <!-- JS Rendered Pagination Controls -->
                </div>
            </div>
        </div>

        <!-- Tab 2: Attachments -->
        <div id="view-attachment" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 h-full flex flex-col p-4 animate-fade-in">
            <!-- Filter Section -->
            <div class="flex flex-wrap items-center justify-between mb-4 shrink-0">
                <div class="flex items-center gap-3">
                    <!-- Custom Dropdown -->
                    <div class="relative w-32" id="attach-type-dropdown">
                        <button id="attach-type-select-btn" class="flex items-center justify-between w-full bg-white border border-gray-300 text-gray-700 py-2 pl-3 pr-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm transition-shadow shadow-sm hover:border-gray-400">
                            <span id="attach-type-select-text" class="text-gray-700">全部</span>
                            <i class="fas fa-chevron-down text-xs text-gray-400 transition-transform duration-200" id="attach-type-select-icon"></i>
                        </button>
                        <div id="attach-type-options" class="hidden absolute top-full left-0 mt-1 w-full bg-white border border-gray-100 rounded-lg shadow-lg z-50 py-1 transform origin-top transition-all duration-200 opacity-0 scale-95">
                            <!-- Options generated by JS -->
                        </div>
                    </div>
                    <div class="relative">
                        <input id="attach-search-input" type="text" placeholder="搜索附件" class="bg-white border border-gray-300 text-gray-700 py-2 pl-3 pr-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-64 text-sm">
                    </div>
                    <button onclick="handleAttachSearch()" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-5 rounded-lg text-sm transition-all shadow-sm">
                        查询
                    </button>
                    <button onclick="handleAttachReset()" class="bg-white hover:bg-gray-50 text-gray-700 border border-gray-300 font-medium py-2 px-5 rounded-lg text-sm transition-all shadow-sm">
                        重置
                    </button>
                </div>
                <button onclick="openAttachUploadModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-6 rounded-lg text-sm transition-all shadow-sm">
                    <i class="fas fa-plus mr-2"></i>上传附件
                </button>
            </div>

            <!-- Table -->
            <div class="table-container flex-1 border border-gray-200 rounded-lg relative overflow-auto">
                <table class="min-w-max w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50/90 backdrop-blur-sm shadow-sm relative z-40">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-center w-12 sticky top-0 left-0 z-30 bg-gray-50">
                                <input type="checkbox" id="attach-select-all-header" onchange="toggleAttachSelectAll(this.checked)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4 cursor-pointer">
                            </th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-1/5 sticky top-0 left-12 z-30 bg-gray-50 shadow-[5px_0_5px_-5px_rgba(0,0,0,0.1)]">名称</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider w-[400px] sticky top-0 z-20 bg-gray-50">介绍</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider sticky top-0 z-20 bg-gray-50">修改日期</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider sticky top-0 z-20 bg-gray-50">关键词</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider sticky top-0 z-20 bg-gray-50">文件类型</th>
                            <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-gray-600 uppercase tracking-wider w-24 sticky top-0 right-0 bg-gray-50 z-30 shadow-[-5px_0_5px_-5px_rgba(0,0,0,0.1)]">操作</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm" id="attach-table-body">
                        <!-- JS Populated -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="attach-pagination" class="flex flex-wrap items-center justify-between pt-3 mt-auto shrink-0">
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                        <input type="checkbox" id="attach-select-all-footer" onchange="toggleAttachSelectAll(this.checked)" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4">
                        全选
                    </label>
                    <button class="text-gray-600 hover:text-blue-600 text-sm font-medium transition-colors">
                        批量下载
                    </button>
                    <div id="attach-total-count" class="text-sm text-gray-600 font-medium ml-4">
                        共 0 条
                    </div>
                </div>
                
                <div id="attach-pagination-controls" class="flex items-center space-x-3">
                    <!-- JS Rendered Pagination Controls -->
                </div>
            </div>
        </div>

        <!-- Tab 3: Configuration -->
        <div id="view-config" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 h-full overflow-hidden animate-fade-in">
            <div class="h-full overflow-y-auto custom-scrollbar">
                <div class="max-w-5xl p-8 space-y-10">
                    
                    <!-- 1. Basic Info -->
                    <section>
                        <h3 class="text-lg font-bold text-gray-800 border-l-4 border-blue-600 pl-3 mb-6">基本信息配置</h3>
                        <div class="flex flex-col gap-6">
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 知识库名称</label>
                                <input type="text" id="config-kb-name" class="w-[600px] bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            <div class="flex items-start gap-4">
                                <label class="w-32 text-sm font-medium text-gray-600 text-right mt-2 flex-shrink-0">知识库简介</label>
                                <textarea id="config-kb-desc" rows="4" class="w-[600px] bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                            </div>
                            <div class="flex items-start gap-4">
                                <label class="w-32 text-sm font-medium text-gray-600 text-right mt-2 flex-shrink-0">封面上传</label>
                                <div class="w-[600px] flex gap-4">
                                    <!-- Preview Area -->
                                    <div id="config-cover-preview" class="w-48 h-28 rounded-lg overflow-hidden border border-gray-200 hidden relative group">
                                        <img id="config-cover-img" src="" class="w-full h-full object-cover">
                                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer" onclick="document.getElementById('config-cover-input').click()">
                                            <span class="text-white text-xs"><i class="fas fa-edit mr-1"></i>更换</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Upload Box -->
                                    <div onclick="document.getElementById('config-cover-input').click()" class="flex-1 border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all h-28">
                                        <input type="file" id="config-cover-input" class="hidden" accept="image/*" onchange="handleConfigCoverSelect(this)">
                                        <i class="fas fa-cloud-upload-alt text-gray-400 text-xl mb-1"></i>
                                        <span class="text-xs text-gray-500">点击上传封面图片</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <hr class="border-gray-100">

                    <!-- 2. Parser Config -->
                    <section>
                        <h3 class="text-lg font-bold text-gray-800 border-l-4 border-blue-600 pl-3 mb-6">解析器配置</h3>
                        <div class="flex flex-col gap-6">
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 文档语言</label>
                                <select class="w-[600px] bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option>中文</option>
                                    <option>English</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 嵌入模型</label>
                                <select class="w-[600px] bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option>BAA/bge-m3</option>
                                    <option>OpenAI/text-embedding-3</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 切片方法</label>
                                <select class="w-[600px] bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option>MinerU</option>
                                    <option>General</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 建议文本大小</label>
                                <div class="w-[600px] flex items-center gap-4">
                                    <input type="range" min="0" max="1000" value="128" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                                    <input type="number" value="128" class="w-20 bg-white border border-gray-300 text-gray-700 py-1 px-2 rounded-lg text-sm text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 文本分段标识符</label>
                                <input type="text" value="\\n!?;。；！？" class="w-[600px] bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm font-mono">
                            </div>
                        </div>
                    </section>

                    <hr class="border-gray-100">

                    <!-- 3. Chunk Config -->
                    <section>
                        <h3 class="text-lg font-bold text-gray-800 border-l-4 border-blue-600 pl-3 mb-6">分块配置</h3>
                        <div class="flex flex-col gap-6">
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 分块策略</label>
                                <select id="config-strategy" class="w-[600px] bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <option>智能分块</option>
                                    <option>固定大小</option>
                                </select>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 最大块大小</label>
                                <div class="w-[600px] flex items-center gap-2">
                                    <input id="config-max-chunk-size" type="number" value="256" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <span class="text-xs text-gray-400 flex-shrink-0">单位: tokens, 范围: 50-2048</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0"><span class="text-red-500">*</span> 最小块大小</label>
                                <div class="w-[600px] flex items-center gap-2">
                                    <input id="config-min-chunk-size" type="number" value="10" class="flex-1 bg-white border border-gray-300 text-gray-700 py-2 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                    <span class="text-xs text-gray-400 flex-shrink-0">单位: tokens, 范围: 10-500</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <hr class="border-gray-100">

                    <!-- 4. Image Attachment Config -->
                    <section>
                        <h3 class="text-lg font-bold text-gray-800 border-l-4 border-blue-600 pl-3 mb-6">图片附件配置</h3>
                        <div class="flex flex-col gap-6">
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0">是否启用图片理解</label>
                                <div class="w-[600px] flex items-center">
                                    <div class="relative inline-block w-12 align-middle select-none transition duration-200 ease-in flex-shrink-0">
                                        <input type="checkbox" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 transition-all duration-300"/>
                                        <label class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                                    </div>
                                    <span class="ml-3 text-xs text-gray-400">图片理解使用视觉语言模型(VLM)为文档中的图片生成文字描述, 使图片内容可被检索。</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="w-32 text-sm font-bold text-gray-600 text-right flex-shrink-0">是否启用图片提取</label>
                                <div class="w-[600px] flex items-center">
                                    <div class="relative inline-block w-12 align-middle select-none transition duration-200 ease-in flex-shrink-0">
                                        <input type="checkbox" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 transition-all duration-300"/>
                                        <label class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                                    </div>
                                    <span class="ml-3 text-xs text-gray-400">图片提取会将文档图片和视觉语言模型理解的文字描述自动存入知识库附件, 方便图片召回。</span>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Bottom Action Bar -->
                    <div class="pt-4 pb-8 flex justify-start pl-[144px]">
                        <button onclick="saveConfig()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-8 rounded-lg shadow-md hover:shadow-lg transition-all">
                            保存配置
                        </button>
                    </div>

                </div>
            </div>
        </div>

    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-[600px] transform scale-95 transition-transform duration-200" id="upload-modal-content">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-800">上传文件</h3>
                <button onclick="closeUploadModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Upload Area -->
                <div id="upload-drop-zone" onclick="document.getElementById('upload-file-input').click()" 
                     class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group relative overflow-hidden">
                    <input type="file" id="upload-file-input" class="hidden" onchange="handleUploadFile(this)">
                    
                    <!-- Normal State -->
                    <div id="upload-state-normal" class="flex flex-col items-center justify-center transition-opacity duration-300">
                        <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cloud-upload-alt text-blue-500 text-xl"></i>
                        </div>
                        <p class="text-sm font-medium text-gray-700" id="upload-text">点击或拖拽文件到此处上传</p>
                        <p class="text-xs text-gray-400 mt-1">支持 PDF, Word, TXT, Markdown 格式</p>
                    </div>

                    <!-- Progress State (Overlay) -->
                    <div id="upload-state-progress" class="hidden absolute inset-0 bg-white flex flex-col items-center justify-center z-10 p-8">
                        <div class="w-full max-w-xs">
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-bold text-blue-600">正在上传...</span>
                                <span class="text-sm font-bold text-blue-600" id="upload-progress-text">0%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                <div id="upload-progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-200 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- File Name -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2"><span class="text-red-500 mr-1">*</span>文件名称</label>
                    <input type="text" id="upload-file-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="上传文件后自动填充">
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <!-- Slicing Method -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">切片方法</label>
                        <div class="relative" id="dropdown-container-upload-method">
                            <button type="button" 
                                class="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-sm flex justify-between items-center hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all outline-none"
                                onclick="toggleCustomDropdown('upload-method', event)">
                                <span id="display-upload-method" class="text-gray-700">MinerU</span>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200" id="arrow-upload-method"></i>
                            </button>
                            
                            <div id="options-upload-method" 
                                class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-100 rounded-lg shadow-[0_4px_20px_rgba(0,0,0,0.08)] overflow-hidden origin-top transform transition-all duration-200 opacity-0 scale-95">
                                <div class="p-1.5 space-y-0.5">
                                    <div onclick="selectCustomOption('upload-method', 'MinerU')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>MinerU</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="MinerU"></i>
                                    </div>
                                    <div onclick="selectCustomOption('upload-method', 'General')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>General</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="General"></i>
                                    </div>
                                    <div onclick="selectCustomOption('upload-method', 'Dots')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>Dots</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="Dots"></i>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="upload-method-input" value="MinerU">
                        </div>
                    </div>

                    <!-- Chunking Strategy -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">分块策略</label>
                        <div class="relative" id="dropdown-container-upload-strategy">
                            <button type="button" 
                                class="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-sm flex justify-between items-center hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all outline-none"
                                onclick="toggleCustomDropdown('upload-strategy', event)">
                                <span id="display-upload-strategy" class="text-gray-700">智能分块</span>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200" id="arrow-upload-strategy"></i>
                            </button>
                            
                            <div id="options-upload-strategy" 
                                class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-100 rounded-lg shadow-[0_4px_20px_rgba(0,0,0,0.08)] overflow-hidden origin-top transform transition-all duration-200 opacity-0 scale-95">
                                <div class="p-1.5 space-y-0.5">
                                    <div onclick="selectCustomOption('upload-strategy', '智能分块')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>智能分块</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="智能分块"></i>
                                    </div>
                                    <div onclick="selectCustomOption('upload-strategy', '固定大小')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>固定大小</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="固定大小"></i>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="upload-strategy-input" value="智能分块">
                        </div>
                    </div>
                </div>

                <!-- Intelligent Strategy Inputs (Upload) -->
                <div id="upload-intelligent-inputs" class="grid grid-cols-2 gap-6 transition-all duration-300">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">最大块大小 (Tokens)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="upload-max-chunk-size" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="1024" value="1024">
                            <span class="text-xs text-gray-400 whitespace-nowrap">范围: 50-2048</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">最小块大小 (Tokens)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="upload-min-chunk-size" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="10" value="10">
                            <span class="text-xs text-gray-400 whitespace-nowrap">范围: 10-500</span>
                        </div>
                    </div>
                </div>

                <!-- Fixed Strategy Inputs (Upload) -->
                <div id="upload-fixed-inputs" class="hidden transition-all duration-300">
                    <label class="block text-sm font-bold text-gray-700 mb-2">分块大小 (Tokens)</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="upload-chunk-size" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="256" value="256">
                        <span class="text-xs text-gray-400 whitespace-nowrap">范围: 50-2048</span>
                    </div>
                </div>
            </div>

            <div class="p-5 border-t border-gray-100 flex justify-end gap-3">
                <button id="btn-cancel-upload" onclick="closeUploadModal()" class="px-4 py-2 text-sm text-gray-600 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors font-medium">取消</button>
                <button id="btn-start-upload" onclick="startUpload()" class="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-medium shadow-sm hover:shadow">开始上传</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-[600px] transform scale-95 transition-transform duration-200" id="edit-modal-content">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-800">编辑知识点</h3>
                <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <input type="hidden" id="edit-id">
                <input type="hidden" id="edit-ext">
                
                <!-- Name -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">知识点名称</label>
                    <input type="text" id="edit-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm">
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <!-- Slicing Method -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">切片方法</label>
                        <div class="relative" id="dropdown-container-method">
                            <button type="button" 
                                class="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-sm flex justify-between items-center hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all outline-none"
                                onclick="toggleCustomDropdown('method', event)">
                                <span id="display-method" class="text-gray-700">MinerU</span>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200" id="arrow-method"></i>
                            </button>
                            
                            <div id="options-method" 
                                class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-100 rounded-lg shadow-[0_4px_20px_rgba(0,0,0,0.08)] overflow-hidden origin-top transform transition-all duration-200 opacity-0 scale-95">
                                <div class="p-1.5 space-y-0.5">
                                    <div onclick="selectCustomOption('method', 'MinerU')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>MinerU</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="MinerU"></i>
                                    </div>
                                    <div onclick="selectCustomOption('method', 'General')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>General</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="General"></i>
                                    </div>
                                    <div onclick="selectCustomOption('method', 'Dots')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>Dots</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="Dots"></i>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="edit-method" value="MinerU">
                        </div>
                    </div>

                    <!-- Chunking Strategy -->
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">分块策略</label>
                        <div class="relative" id="dropdown-container-strategy">
                            <button type="button" 
                                class="w-full px-3 py-2.5 bg-white border border-gray-300 rounded-lg text-sm flex justify-between items-center hover:border-blue-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all outline-none"
                                onclick="toggleCustomDropdown('strategy', event)">
                                <span id="display-strategy" class="text-gray-700">智能分块</span>
                                <i class="fas fa-chevron-down text-gray-400 text-xs transition-transform duration-200" id="arrow-strategy"></i>
                            </button>
                            
                            <div id="options-strategy" 
                                class="hidden absolute z-50 w-full mt-1 bg-white border border-gray-100 rounded-lg shadow-[0_4px_20px_rgba(0,0,0,0.08)] overflow-hidden origin-top transform transition-all duration-200 opacity-0 scale-95">
                                <div class="p-1.5 space-y-0.5">
                                    <div onclick="selectCustomOption('strategy', '智能分块')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>智能分块</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="智能分块"></i>
                                    </div>
                                    <div onclick="selectCustomOption('strategy', '固定大小')" class="px-3 py-2 rounded-md text-sm text-gray-600 hover:text-blue-600 hover:bg-blue-50 cursor-pointer transition-colors flex items-center justify-between group/item">
                                        <span>固定大小</span>
                                        <i class="fas fa-check text-blue-600 opacity-0 transition-opacity text-xs check-icon" data-value="固定大小"></i>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="edit-chunk-strategy" value="智能分块">
                        </div>
                    </div>
                </div>

                <!-- Intelligent Strategy Inputs -->
                    <div id="intelligent-inputs" class="hidden grid grid-cols-2 gap-6 transition-all duration-300">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">最大块大小 (Tokens)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="edit-max-chunk-size" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="1024">
                                <span class="text-xs text-gray-400 whitespace-nowrap">范围: 50-2048</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-2">最小块大小 (Tokens)</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="edit-min-chunk-size" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="10">
                                <span class="text-xs text-gray-400 whitespace-nowrap">范围: 10-500</span>
                            </div>
                        </div>
                    </div>

                    <!-- Fixed Strategy Inputs -->
                    <div id="fixed-inputs" class="hidden transition-all duration-300">
                        <label class="block text-sm font-bold text-gray-700 mb-2">分块大小 (Tokens)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="edit-chunk-size" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="256">
                            <span class="text-xs text-gray-400 whitespace-nowrap">范围: 50-2048</span>
                        </div>
                    </div>
            </div>

            <div class="p-5 border-t border-gray-100 flex justify-end gap-3">
                <button onclick="closeEditModal()" class="px-4 py-2 text-sm text-gray-600 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors font-medium">取消</button>
                <button onclick="saveEdit()" class="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-medium shadow-sm hover:shadow">保存修改</button>
            </div>
        </div>
    </div>

    <!-- Crop Modal (Reused from knowledge.html) -->
    <div id="crop-modal" class="fixed inset-0 bg-black/80 hidden flex items-center justify-center z-[120] backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-[800px] h-[600px] flex flex-col transform scale-95 transition-transform duration-200" id="crop-modal-content">
            <div class="flex justify-between items-center p-5 border-b border-gray-100 shrink-0">
                <h3 class="text-lg font-bold text-gray-800">裁剪封面图片</h3>
                <button onclick="closeCropModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex-1 bg-gray-900 overflow-hidden relative p-4">
                <div class="h-full w-full">
                    <img id="crop-image" src="" class="block max-w-full">
                </div>
            </div>

            <!-- Toolbar -->
            <div class="bg-gray-800 p-3 flex justify-center gap-4 border-t border-gray-700 shrink-0">
                <button type="button" onclick="cropper.zoom(0.1)" class="text-white hover:text-blue-400 transition-colors p-2" title="放大">
                    <i class="fas fa-search-plus text-lg"></i>
                </button>
                <button type="button" onclick="cropper.zoom(-0.1)" class="text-white hover:text-blue-400 transition-colors p-2" title="缩小">
                    <i class="fas fa-search-minus text-lg"></i>
                </button>
                <div class="w-px bg-gray-600 mx-2"></div>
                <button type="button" onclick="cropper.rotate(-90)" class="text-white hover:text-blue-400 transition-colors p-2" title="向左旋转">
                    <i class="fas fa-undo text-lg"></i>
                </button>
                <button type="button" onclick="cropper.rotate(90)" class="text-white hover:text-blue-400 transition-colors p-2" title="向右旋转">
                    <i class="fas fa-redo text-lg"></i>
                </button>
                <div class="w-px bg-gray-600 mx-2"></div>
                <button type="button" onclick="cropper.reset()" class="text-white hover:text-blue-400 transition-colors p-2" title="重置">
                    <i class="fas fa-sync-alt text-lg"></i>
                </button>
            </div>

            <div class="p-5 border-t border-gray-100 flex justify-end gap-3 shrink-0 bg-white rounded-b-xl">
                <button onclick="closeCropModal()" class="px-5 py-2 text-sm text-gray-600 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg transition-colors font-medium">取消</button>
                <button onclick="confirmCrop()" class="px-5 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-medium shadow-sm hover:shadow">确认剪裁</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[110] backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-[350px] transform scale-95 transition-transform duration-200" id="delete-modal-content">
            <div class="p-6 text-center">
                <!-- Icon -->
                <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                </div>
                
                <!-- Title -->
                <h3 class="text-lg font-bold text-gray-800 mb-2">确认删除</h3>
                
                <!-- Message -->
                <p class="text-sm text-gray-500 mb-6">您确定要删除该知识点吗？此操作无法撤销。</p>
                
                <!-- Buttons -->
                <div class="flex justify-center gap-3">
                    <button onclick="closeDeleteModal()" class="px-4 py-2 text-sm text-gray-600 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors font-medium">取消</button>
                    <button onclick="confirmDelete()" class="px-4 py-2 text-sm text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors font-medium shadow-sm hover:shadow">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attachment Upload Modal -->
    <div id="attach-upload-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-[600px] transform scale-95 transition-transform duration-200" id="attach-upload-modal-content">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-800">上传附件</h3>
                <button onclick="closeAttachUploadModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- Upload Area -->
                <div id="attach-upload-drop-zone" onclick="document.getElementById('attach-upload-file-input').click()" 
                     class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition-all group relative overflow-hidden">
                    <input type="file" id="attach-upload-file-input" class="hidden" onchange="handleAttachUploadFile(this)" accept="image/*,video/*">
                    
                    <!-- Normal State -->
                    <div id="attach-upload-state-normal" class="flex flex-col items-center justify-center transition-opacity duration-300">
                        <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i class="fas fa-cloud-upload-alt text-blue-500 text-xl"></i>
                        </div>
                        <p class="text-sm font-medium text-gray-700" id="attach-upload-text">点击或拖拽文件到此处上传</p>
                        <p class="text-xs text-gray-400 mt-1">支持 JPG, PNG, MP4, AVI 等图片或视频格式</p>
                    </div>

                    <!-- Progress State (Overlay) -->
                    <div id="attach-upload-state-progress" class="hidden absolute inset-0 bg-white flex flex-col items-center justify-center z-10 p-8">
                        <div class="w-full max-w-xs">
                            <div class="flex justify-between mb-2">
                                <span class="text-sm font-bold text-blue-600">正在上传...</span>
                                <span class="text-sm font-bold text-blue-600" id="attach-upload-progress-text">0%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                <div id="attach-upload-progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-200 ease-out" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- File Name -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2"><span class="text-red-500 mr-1">*</span>文件名称</label>
                    <input type="text" id="attach-upload-file-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="上传文件后自动填充">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">描述</label>
                    <textarea id="attach-upload-desc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="请输入附件描述..."></textarea>
                </div>

                <!-- Keywords -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2"><span class="text-red-500 mr-1">*</span>关键词</label>
                    <input type="text" id="attach-upload-keywords" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm" placeholder="多个关键词请用逗号分隔">
                </div>
            </div>

            <div class="p-5 border-t border-gray-100 flex justify-end gap-3">
                <button id="btn-cancel-attach-upload" onclick="closeAttachUploadModal()" class="px-4 py-2 text-sm text-gray-600 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors font-medium">取消</button>
                <button id="btn-start-attach-upload" onclick="startAttachUpload()" class="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-medium shadow-sm hover:shadow disabled:opacity-50 disabled:cursor-not-allowed">开始上传</button>
            </div>
        </div>
    </div>

    <!-- Attachment Edit Modal -->
    <div id="attach-edit-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[100] backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-[600px] transform scale-95 transition-transform duration-200" id="attach-edit-modal-content">
            <div class="flex justify-between items-center p-5 border-b border-gray-100">
                <h3 class="text-lg font-bold text-gray-800">编辑附件</h3>
                <button onclick="closeAttachEditModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <input type="hidden" id="attach-edit-id">
                <input type="hidden" id="attach-edit-ext">
                
                <!-- File Name -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2"><span class="text-red-500 mr-1">*</span>文件名称</label>
                    <input type="text" id="attach-edit-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">描述</label>
                    <textarea id="attach-edit-desc" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm"></textarea>
                </div>

                <!-- Keywords -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">关键词</label>
                    <input type="text" id="attach-edit-keywords" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-sm">
                </div>
            </div>

            <div class="p-5 border-t border-gray-100 flex justify-end gap-3">
                <button onclick="closeAttachEditModal()" class="px-4 py-2 text-sm text-gray-600 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors font-medium">取消</button>
                <button onclick="saveAttachEdit()" class="px-4 py-2 text-sm text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors font-medium shadow-sm hover:shadow">保存修改</button>
            </div>
        </div>
    </div>

    <!-- Attachment Delete Modal -->
    <div id="attach-delete-modal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[110] backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-[350px] transform scale-95 transition-transform duration-200" id="attach-delete-modal-content">
            <div class="p-6 text-center">
                <!-- Icon -->
                <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-red-500 text-xl"></i>
                </div>
                
                <!-- Title -->
                <h3 class="text-lg font-bold text-gray-800 mb-2">确认删除</h3>
                
                <!-- Message -->
                <p class="text-sm text-gray-500 mb-6">您确定要删除该附件吗？此操作无法撤销。</p>
                
                <!-- Buttons -->
                <div class="flex justify-center gap-3">
                    <button onclick="closeAttachDeleteModal()" class="px-4 py-2 text-sm text-gray-600 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors font-medium">取消</button>
                    <button onclick="confirmAttachDelete()" class="px-4 py-2 text-sm text-white bg-red-500 hover:bg-red-600 rounded-lg transition-colors font-medium shadow-sm hover:shadow">删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification (Reused) -->
    <div id="toast" class="fixed top-4 right-4 bg-white border border-green-100 shadow-[0_8px_30px_rgb(0,0,0,0.12)] rounded-lg p-4 flex items-center gap-3 transform translate-x-[120%] transition-transform duration-300 z-[100]">
        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-500 shrink-0">
            <i class="fas fa-check"></i>
        </div>
        <div>
            <h4 class="font-bold text-gray-800 text-sm">操作成功</h4>
            <p class="text-xs text-gray-500 mt-0.5" id="toast-msg">操作已完成</p>
        </div>
    </div>

    <script>
        // --- Init State from URL ---
        let currentKbId = null;
        let totalDocCount = 0;
        let currentKbData = null;
        let initialKbSnapshot = null;
        let baseKbVersion = 0;
        let initialConfigFormSnapshot = null;
        let isConfigDirty = false;
        let returnSyncSent = false;
        let pendingReturnSync = false;
        const SYNC_EVENT_KEY = 'kb_sync_event_v1';
        const SYNC_APPLIED_KEY = 'kb_sync_applied_v1';
        
        function initPageFromUrl() {
            const params = new URLSearchParams(window.location.search);
            const kbName = params.get('name');
            const kbId = params.get('id');
            
            if (kbName) {
                document.getElementById('kb-title').textContent = decodeURIComponent(kbName);
                document.title = `${decodeURIComponent(kbName)} - 知识库详情`;
            }
            
            if (kbId) {
                currentKbId = kbId;
                console.log(`Loaded Knowledge Base ID: ${kbId}`);
                
                // Retrieve docCount and details from localStorage
                const stored = localStorage.getItem('iClass_kb_list_v4');
                if (stored) {
                    const kbListStored = JSON.parse(stored);
                    const currentKb = kbListStored.find(item => item.id == kbId);
                    if (currentKb) {
                        currentKbData = currentKb;
                        baseKbVersion = currentKb.version || 0;
                        initialKbSnapshot = buildKbSnapshot(currentKb);
                        totalDocCount = (currentKb.docCount !== undefined) ? currentKb.docCount : 50;
                        
                        // Populate Config Form
                        document.getElementById('config-kb-name').value = currentKb.title || '';
                        document.getElementById('config-kb-desc').value = currentKb.desc || '';
                        
                        // Populate Cover if exists
                        if (currentKb.cover) {
                            const preview = document.getElementById('config-cover-preview');
                            const img = document.getElementById('config-cover-img');
                            const uploadBox = document.getElementById('config-cover-input').parentElement;
                            
                            img.src = currentKb.cover;
                            preview.classList.remove('hidden');
                            uploadBox.classList.add('hidden'); // Hide upload box when cover exists, or keep both? 
                            // Better UX: Show preview next to upload box, or replace it.
                            // Let's keep preview visible and upload box as "Change" button logic mostly.
                            // Adjusted HTML structure allows side-by-side.
                            uploadBox.classList.remove('flex-1');
                            uploadBox.classList.add('w-48');
                            uploadBox.querySelector('span').textContent = '点击更换图片';
                        }
                    }
                }
                
                // Simulate loading state
                simulateLoading();
            }
        }

        function buildKbSnapshot(data) {
            return {
                title: data && data.title ? data.title : '',
                desc: data && data.desc ? data.desc : '',
                cover: data && data.cover ? data.cover : '',
                status: data && data.status ? data.status : ''
            };
        }

        function normalizeCover(cover) {
            if (!cover) return '';
            if (cover.endsWith('knowledge-detail.html')) return '';
            return cover;
        }

        function getConfigFormSnapshot() {
            const container = document.getElementById('view-config');
            if (!container) return '';
            const fields = Array.from(container.querySelectorAll('input, select, textarea'));
            const snapshot = fields.map((el, index) => {
                const tag = el.tagName.toLowerCase();
                const type = (el.type || '').toLowerCase();
                const key = el.id || el.name || `${tag}:${type}:${index}`;
                if (type === 'file') {
                    return `${key}=`;
                }
                if (type === 'checkbox') {
                    return `${key}=${el.checked ? 1 : 0}`;
                }
                return `${key}=${el.value ?? ''}`;
            });
            const coverImg = document.getElementById('config-cover-img');
            if (coverImg) {
                snapshot.push(`config-cover-img=${coverImg.src || ''}`);
            }
            return snapshot.join('|');
        }

        function markConfigDirty() {
            isConfigDirty = true;
        }

        function isConfigFormChanged() {
            const current = getConfigFormSnapshot();
            if (initialConfigFormSnapshot === null) {
                initialConfigFormSnapshot = current;
                return false;
            }
            return current !== initialConfigFormSnapshot;
        }

        function isSnapshotEqual(a, b) {
            return (a.title || '') === (b.title || '') &&
                   (a.desc || '') === (b.desc || '') &&
                   (a.cover || '') === (b.cover || '') &&
                   (a.status || '') === (b.status || '');
        }

        function getNowTimeString() {
            return new Date().toISOString().slice(0, 19).replace('T', ' ');
        }

        function getNextSyncTimestamp() {
            const nowTs = Date.now();
            const lastApplied = parseInt(localStorage.getItem(SYNC_APPLIED_KEY)) || 0;
            return nowTs <= lastApplied ? lastApplied + 1 : nowTs;
        }

        function emitSyncEvent(payload) {
            localStorage.setItem(SYNC_EVENT_KEY, JSON.stringify(payload));
        }

        function emitReturnSyncFromLatest() {
            if (!currentKbId) return false;
            const stored = localStorage.getItem('iClass_kb_list_v4');
            if (!stored) return false;
            let list;
            try {
                list = JSON.parse(stored);
            } catch (e) {
                return false;
            }
            const latest = list.find(item => item.id == currentKbId);
            if (!latest) return false;
            const nowTs = getNextSyncTimestamp();
            emitSyncEvent({
                id: currentKbId,
                data: {
                    title: latest.title,
                    desc: latest.desc,
                    cover: latest.cover,
                    status: latest.status,
                    docCount: latest.docCount
                },
                time: latest.time,
                updatedAt: latest.updatedAt,
                version: latest.version,
                ts: nowTs,
                returnToList: true
            });
            return true;
        }

        function handleBackToList() {
            returnSyncSent = saveConfig(true);
            if (!returnSyncSent && pendingReturnSync) {
                returnSyncSent = emitReturnSyncFromLatest();
                pendingReturnSync = false;
            }
            if (history.length > 1) {
                history.back();
            } else {
                window.location.href = 'knowledge.html';
            }
            return false;
        }
        
        function simulateLoading() {
            // Show loading state for tables
            const tbody = document.getElementById('kp-table-body');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i><p class="text-gray-500 mt-2">正在加载知识点...</p></td></tr>';
            
            const attachBody = document.getElementById('attach-table-body');
            attachBody.innerHTML = '<tr><td colspan="7" class="text-center py-10"><i class="fas fa-spinner fa-spin text-blue-500 text-2xl"></i><p class="text-gray-500 mt-2">正在加载附件...</p></td></tr>';
            
            // Simulate network delay then render
            setTimeout(() => {
                // If totalDocCount is 0, render empty state
                if (totalDocCount === 0) {
                    kpList = [];
                    attachList = [];
                    renderKPTable();
                    renderAttachTable();
                    return;
                }

                // Distribute counts
                // Ensure at least 1 attachment if total > 0, but generally random split
                // Let KP count be majority (e.g., 60-80%)
                let kpCount = Math.floor(totalDocCount * (0.6 + Math.random() * 0.2));
                let attachCount = totalDocCount - kpCount;
                
                // Ensure valid counts
                if (kpCount < 0) kpCount = 0;
                if (attachCount < 0) attachCount = 0;
                
                // Generate Data
                kpList = generateMockData(kpCount);
                
                // Update Attach List logic to respect count
                // We need to regenerate attachList instead of using static array
                generateAttachData(attachCount);
                
                renderKPTable(); 
                renderAttachTable(); 
            }, 600);
        }
        
        function generateAttachData(count) {
             const baseNames = ['系统架构图', '流程演示视频', '部署拓扑图', '接口时序图', '用户操作录屏', '故障排查指引', '功能特性介绍', '网络配置图'];
             const types = ['图片', '视频'];
             
             attachList = [];
             for(let i=0; i<count; i++) {
                 const type = Math.random() > 0.7 ? '视频' : '图片';
                 const ext = type === '视频' ? '.mp4' : '.png';
                 const base = baseNames[Math.floor(Math.random() * baseNames.length)];
                 
                 attachList.push({
                    id: 1000 + i,
                    name: `${base}_${i+1}${ext}`,
                    desc: `关于${base}的详细说明附件`,
                    date: new Date(Date.now() - Math.floor(Math.random() * 1000000000)).toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '/'),
                    keywords: `${base},${type},说明`,
                    type: type
                 });
             }
        }

        // --- Crop Logic ---
        let cropper;
        let cropImage = document.getElementById('crop-image');
        
        function handleConfigCoverSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    cropImage.src = e.target.result;
                    openCropModal();
                }
                reader.readAsDataURL(input.files[0]);
                // Reset input to allow re-selecting same file
                input.value = '';
            }
        }

        function openCropModal() {
            const modal = document.getElementById('crop-modal');
            const content = document.getElementById('crop-modal-content');
            
            modal.classList.remove('hidden');
            // Trigger reflow
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
            
            // Init Cropper
            if (cropper) {
                cropper.destroy();
            }
            cropper = new Cropper(cropImage, {
                aspectRatio: 280 / 144, // Match card aspect ratio
                viewMode: 1,
                autoCropArea: 1,
            });
        }

        function closeCropModal() {
            const modal = document.getElementById('crop-modal');
            const content = document.getElementById('crop-modal-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
            }, 200);
        }

        function confirmCrop() {
            if (!cropper) return;
            
            const canvas = cropper.getCroppedCanvas({
                width: 500, // Reasonable width for cover
                height: 257
            });
            
            const base64 = canvas.toDataURL('image/jpeg', 0.8);
            
            // Update Preview in Config Tab
            const preview = document.getElementById('config-cover-preview');
            const img = document.getElementById('config-cover-img');
            const uploadBox = document.getElementById('config-cover-input').parentElement;
            
            img.src = base64;
            preview.classList.remove('hidden');
            
            // Adjust layout
            uploadBox.classList.remove('flex-1');
            uploadBox.classList.add('w-48');
            uploadBox.querySelector('span').textContent = '点击更换图片';
            
            closeCropModal();
            markConfigDirty();
        }

        function saveConfig(isReturn = false) {
            if (!currentKbId || !currentKbData) return false;
            
            const newName = document.getElementById('config-kb-name').value.trim();
            const newDesc = document.getElementById('config-kb-desc').value.trim();
            const coverImg = document.getElementById('config-cover-img').src;
            
            if (!newName) {
                if (!isReturn) showToast('知识库名称不能为空', 'error');
                return false;
            }

            const strategy = document.getElementById('config-strategy').value;
            const maxChunk = parseInt(document.getElementById('config-max-chunk-size').value);
            const minChunk = parseInt(document.getElementById('config-min-chunk-size').value);
            const configChanged = kbConfig.strategy !== strategy || kbConfig.maxChunkSize !== maxChunk || kbConfig.minChunkSize !== minChunk;
            kbConfig.strategy = strategy;
            kbConfig.maxChunkSize = maxChunk;
            kbConfig.minChunkSize = minChunk;
            
            const stored = localStorage.getItem('iClass_kb_list_v4');
            if (!stored) return false;
            const list = JSON.parse(stored);
            const index = list.findIndex(item => item.id == currentKbId);
            if (index === -1) return false;
            
            const latest = list[index];
            const latestSnapshot = buildKbSnapshot(latest);
            const baseSnapshot = initialKbSnapshot || latestSnapshot;
            const normalizedCover = normalizeCover(coverImg) || latestSnapshot.cover || '';
            const nextSnapshot = {
                title: newName,
                desc: newDesc,
                cover: normalizedCover,
                status: latest.status || ''
            };
            
            const formChanged = isConfigFormChanged() || isConfigDirty;
            const hasBasicChange = !isSnapshotEqual(nextSnapshot, latestSnapshot);
            const hasConflict = (latest.version || 0) > baseKbVersion && !isSnapshotEqual(latestSnapshot, baseSnapshot);
            const hasAnyChange = hasBasicChange || configChanged || formChanged;
            
            if (hasAnyChange) {
                const nowTime = getNowTimeString();
                const nowTs = getNextSyncTimestamp();
                const newVersion = (latest.version || 0) + 1;
                const updated = {
                    ...latest,
                    ...(hasBasicChange ? nextSnapshot : {}),
                    time: nowTime,
                    updatedAt: nowTs,
                    version: newVersion
                };
                list[index] = updated;
                localStorage.setItem('iClass_kb_list_v4', JSON.stringify(list));
                currentKbData = updated;
                initialKbSnapshot = buildKbSnapshot(updated);
                baseKbVersion = newVersion;
                
                document.getElementById('kb-title').textContent = newName;
                document.title = `${newName} - 知识库详情`;
                
                emitSyncEvent({
                    id: currentKbId,
                    data: {
                        title: updated.title,
                        desc: updated.desc,
                        cover: updated.cover,
                        status: updated.status,
                        docCount: updated.docCount
                    },
                    time: updated.time,
                    updatedAt: updated.updatedAt,
                    version: updated.version,
                    ts: nowTs,
                    returnToList: isReturn
                });
                initialConfigFormSnapshot = getConfigFormSnapshot();
                isConfigDirty = false;
                if (isReturn) {
                    returnSyncSent = true;
                    pendingReturnSync = false;
                } else {
                    pendingReturnSync = true;
                }
                
                if (!isReturn) showToast(hasConflict ? '检测到并发更新，已合并并保存' : '配置已保存', 'success');
                return true;
            }

            if (configChanged) {
                showToast('配置已保存', 'success');
            } else {
                showToast('未检测到变更', 'success');
            }
            return false;
        }
        function switchTab(tabName) {
            // Update Tab Buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'text-blue-600', 'border-blue-600');
                btn.classList.add('border-transparent', 'text-gray-600');
            });
            const activeBtn = document.getElementById(`tab-${tabName}`);
            activeBtn.classList.add('active', 'text-blue-600', 'border-blue-600');
            activeBtn.classList.remove('border-transparent', 'text-gray-600');

            // Update Views
            document.getElementById('view-management').classList.add('hidden');
            document.getElementById('view-attachment').classList.add('hidden');
            document.getElementById('view-config').classList.add('hidden');
            
            document.getElementById(`view-${tabName}`).classList.remove('hidden');
        }

        // --- 2. Data Management (Interactive Upgrade) ---
        
        // Global State
        let kpList = [];
        let currentPage = 1;
        let pageSize = 8;

        // Global Config State
        let kbConfig = {
            strategy: '智能分块',
            maxChunkSize: 256,
            minChunkSize: 10
        };

        let currentFilter = {
            status: '全部',
            keyword: ''
        };
        let selectedIds = new Set();
        let deleteId = null;

        // --- Interaction Logic ---

        // Toggle Selection
        function toggleSelection(id, checked) {
            if (checked) {
                selectedIds.add(id);
            } else {
                selectedIds.delete(id);
            }
            updateSelectAllState();
        }

        // Toggle Select All (Current Page)
        function toggleSelectAll(checked) {
            const data = getCurrentPageData();
            data.forEach(item => {
                if (checked) {
                    selectedIds.add(item.id);
                } else {
                    selectedIds.delete(item.id);
                }
            });
            renderKPTable();
        }

        // Update Select All Checkbox State
        function updateSelectAllState() {
            const data = getCurrentPageData();
            if (data.length === 0) return;
            
            const allSelected = data.every(item => selectedIds.has(item.id));
            const headerCheckbox = document.getElementById('kp-select-all-header');
            const footerCheckbox = document.getElementById('kp-select-all-footer');
            
            if (headerCheckbox) headerCheckbox.checked = allSelected;
            if (footerCheckbox) footerCheckbox.checked = allSelected;
        }

        // Delete Item
        function deleteItem(id) {
            deleteId = id;
            const modal = document.getElementById('delete-modal');
            const content = document.getElementById('delete-modal-content');
            modal.classList.remove('hidden');
            // Trigger reflow
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }

        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            const content = document.getElementById('delete-modal-content');
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
                deleteId = null;
            }, 200);
        }

        function confirmDelete() {
            if (deleteId) {
                const itemToDelete = kpList.find(i => i.id === deleteId);
                const wasParsing = itemToDelete && itemToDelete.status === '解析中';

                kpList = kpList.filter(item => item.id !== deleteId);
                selectedIds.delete(deleteId);
                
                // If deleted item was Parsing, promote next Pending item
                if (wasParsing) {
                    const nextPending = kpList.find(i => i.status === '待解析');
                    if (nextPending) {
                        nextPending.status = '解析中';
                        nextPending.statusColor = 'bg-orange-100 text-orange-600 border-orange-200';
                        // Keep enabled = false
                        
                        // Re-sort: Pending (0) > Processing (1) > Others (2), then by Time
                        kpList.sort((a, b) => {
                            const getStatusPriority = (status) => {
                                if (status === '待解析') return 0;
                                if (status === '解析中') return 1;
                                return 2;
                            };
                            const priorityA = getStatusPriority(a.status);
                            const priorityB = getStatusPriority(b.status);
                            if (priorityA !== priorityB) return priorityA - priorityB;
                            return b.timestamp - a.timestamp;
                        });
                    }
                }

                // Adjust page if empty
                const maxPage = Math.ceil(getFilteredData().length / pageSize);
                if (currentPage > maxPage && maxPage > 0) {
                    currentPage = maxPage;
                }
                
                renderKPTable();
                showToast('知识点已删除', 'success');
                closeDeleteModal();
            }
        }

        // Toggle KP Status
        function toggleKPStatus(id) {
            const item = kpList.find(i => i.id === id);
            if (item) {
                item.enabled = !item.enabled;
                renderKPTable();
                showToast(`状态已${item.enabled ? '启用' : '禁用'}`, 'success');
            }
        }

        // Retry Parsing
        function retryParsing(id) {
            const item = kpList.find(i => i.id === id);
            if (item) {
                // Update Status to Pending
                item.status = '待解析';
                item.statusColor = 'bg-green-100 text-green-600 border-green-200';
                item.enabled = false;
                
                // Update timestamp to now to ensure it appears at the top
                item.timestamp = Date.now();
                item.date = new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '/');

                // Re-sort: Pending (0) > Processing (1) > Others (2), then by Time
                kpList.sort((a, b) => {
                    const getStatusPriority = (status) => {
                        if (status === '待解析') return 0;
                        if (status === '解析中') return 1;
                        return 2;
                    };
                    const priorityA = getStatusPriority(a.status);
                    const priorityB = getStatusPriority(b.status);
                    if (priorityA !== priorityB) return priorityA - priorityB;
                    return b.timestamp - a.timestamp; 
                });

                // Reset to page 1 to see the updated item at top
                currentPage = 1;
                renderKPTable();
                showToast('已重新加入解析队列', 'success');
            }
        }

        // Edit Modal Logic
        function openEditModal(id) {
            const item = kpList.find(i => i.id === id);
            if (!item) return;
            
            document.getElementById('edit-id').value = item.id;
            
            // Separate Name and Extension
            const fileName = item.name;
            const lastDotIndex = fileName.lastIndexOf('.');
            let nameWithoutExt = fileName;
            let ext = '';
            
            if (lastDotIndex !== -1) {
                nameWithoutExt = fileName.substring(0, lastDotIndex);
                ext = fileName.substring(lastDotIndex);
            }
            
            document.getElementById('edit-name').value = nameWithoutExt;
            document.getElementById('edit-ext').value = ext;
            
            // Set values for custom dropdowns
            selectCustomOption('method', item.method || 'MinerU');
            selectCustomOption('strategy', item.chunkStrategy || '智能分块');
            
            document.getElementById('edit-max-chunk-size').value = item.maxChunkSize || 1024;
            document.getElementById('edit-min-chunk-size').value = item.minChunkSize || 10;
            document.getElementById('edit-chunk-size').value = item.chunkSize || 256;
            
            toggleChunkSizeInput(); // Set initial visibility
            
            const modal = document.getElementById('edit-modal');
            const content = document.getElementById('edit-modal-content');
            
            modal.classList.remove('hidden');
            // Trigger reflow
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }

        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            const content = document.getElementById('edit-modal-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        // --- Custom Dropdown Logic ---
        function toggleCustomDropdown(type, event) {
            event.stopPropagation();
            const options = document.getElementById(`options-${type}`);
            const arrow = document.getElementById(`arrow-${type}`);
            const isHidden = options.classList.contains('hidden');

            // Close all other dropdowns
            document.querySelectorAll('[id^="options-"]').forEach(el => {
                if (el.id !== `options-${type}`) {
                    el.classList.add('hidden', 'opacity-0', 'scale-95');
                }
            });
            document.querySelectorAll('[id^="arrow-"]').forEach(el => {
                if (el.id !== `arrow-${type}`) {
                    el.classList.remove('rotate-180');
                }
            });

            if (isHidden) {
                options.classList.remove('hidden');
                // Trigger reflow
                void options.offsetWidth;
                options.classList.remove('opacity-0', 'scale-95');
                arrow.classList.add('rotate-180');
            } else {
                options.classList.add('opacity-0', 'scale-95');
                arrow.classList.remove('rotate-180');
                setTimeout(() => {
                    options.classList.add('hidden');
                }, 200);
            }
        }

        function selectCustomOption(type, value) {
            // Update hidden input
            let inputId;
            if (type === 'method') inputId = 'edit-method';
            else if (type === 'strategy') inputId = 'edit-chunk-strategy';
            else if (type === 'upload-method') inputId = 'upload-method-input';
            else if (type === 'upload-strategy') inputId = 'upload-strategy-input';
            
            if (inputId && document.getElementById(inputId)) {
                document.getElementById(inputId).value = value;
            }

            // Update display text
            const displayEl = document.getElementById(`display-${type}`);
            if (displayEl) displayEl.innerText = value;

            // Update checkmarks
            const container = document.getElementById(`options-${type}`);
            if (container) {
                container.querySelectorAll('.check-icon').forEach(icon => {
                    if (icon.getAttribute('data-value') === value) {
                        icon.classList.remove('opacity-0');
                    } else {
                        icon.classList.add('opacity-0');
                    }
                });
            }

            // Close dropdown
            const options = document.getElementById(`options-${type}`);
            const arrow = document.getElementById(`arrow-${type}`);
            if (options) {
                options.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    options.classList.add('hidden');
                }, 200);
            }
            if (arrow) arrow.classList.remove('rotate-180');

            // Specific logic for strategy change
            if (type === 'strategy') {
                toggleChunkSizeInput();
            } else if (type === 'upload-strategy') {
                toggleUploadChunkSizeInput();
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.relative')) {
                document.querySelectorAll('[id^="options-"]').forEach(el => {
                    el.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        el.classList.add('hidden');
                    }, 200);
                });
                document.querySelectorAll('[id^="arrow-"]').forEach(el => {
                    el.classList.remove('rotate-180');
                });
            }
        });

        function toggleChunkSizeInput() {
            const strategy = document.getElementById('edit-chunk-strategy').value;
            const intelligentInputs = document.getElementById('intelligent-inputs');
            const fixedInputs = document.getElementById('fixed-inputs');
            
            if (strategy === '智能分块') {
                intelligentInputs.classList.remove('hidden');
                fixedInputs.classList.add('hidden');
            } else if (strategy === '固定大小') {
                intelligentInputs.classList.add('hidden');
                fixedInputs.classList.remove('hidden');
            } else {
                intelligentInputs.classList.add('hidden');
                fixedInputs.classList.add('hidden');
            }
        }

        function toggleUploadChunkSizeInput() {
            const strategy = document.getElementById('upload-strategy-input').value;
            const intelligentInputs = document.getElementById('upload-intelligent-inputs');
            const fixedInputs = document.getElementById('upload-fixed-inputs');
            
            if (strategy === '智能分块') {
                intelligentInputs.classList.remove('hidden');
                fixedInputs.classList.add('hidden');
            } else if (strategy === '固定大小') {
                intelligentInputs.classList.add('hidden');
                fixedInputs.classList.remove('hidden');
            } else {
                intelligentInputs.classList.add('hidden');
                fixedInputs.classList.add('hidden');
            }
        }

        function saveEdit() {
            const id = parseInt(document.getElementById('edit-id').value);
            let name = document.getElementById('edit-name').value.trim();
            const ext = document.getElementById('edit-ext').value;
            const method = document.getElementById('edit-method').value;
            const chunkStrategy = document.getElementById('edit-chunk-strategy').value;
            const chunkSize = parseInt(document.getElementById('edit-chunk-size').value);
            const minChunkSize = parseInt(document.getElementById('edit-min-chunk-size').value);
            const maxChunkSize = parseInt(document.getElementById('edit-max-chunk-size').value);
            
            if (!name) {
                alert('请输入名称');
                return;
            }
            
            // Append extension if not already present
            if (ext && !name.endsWith(ext)) {
                name += ext;
            }
            
            const item = kpList.find(i => i.id === id);
            if (item) {
                // Check if config changed
                let configChanged = false;
                if (item.method !== method || item.chunkStrategy !== chunkStrategy) {
                    configChanged = true;
                } else {
                     if (chunkStrategy === '智能分块') {
                        if (item.maxChunkSize !== maxChunkSize || item.minChunkSize !== minChunkSize) {
                            configChanged = true;
                        }
                    } else if (chunkStrategy === '固定大小') {
                        if (item.chunkSize !== chunkSize) {
                            configChanged = true;
                        }
                    }
                }

                item.name = name;
                item.method = method;
                item.chunkStrategy = chunkStrategy;
                
                if (chunkStrategy === '智能分块') {
                    item.maxChunkSize = maxChunkSize;
                    item.minChunkSize = minChunkSize;
                } else if (chunkStrategy === '固定大小') {
                    item.chunkSize = chunkSize;
                }
                
                if (configChanged) {
                    // Status Update to Pending Parsing
                    item.status = '待解析';
                    item.statusColor = 'bg-green-100 text-green-600 border-green-200'; // Using existing green style for Pending/Active
                    item.enabled = false; // Disable toggle during parsing
                    
                    // Update timestamp to now to ensure it appears at the top
                    item.timestamp = Date.now();
                    item.date = new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '/');

                    // Re-sort: Pending (0) > Processing (1) > Others (2), then by Time
                    kpList.sort((a, b) => {
                        const getStatusPriority = (status) => {
                            if (status === '待解析') return 0;
                            if (status === '解析中') return 1;
                            return 2;
                        };
                        const priorityA = getStatusPriority(a.status);
                        const priorityB = getStatusPriority(b.status);
                        if (priorityA !== priorityB) return priorityA - priorityB;
                        // If same priority, new one first (simulated by ID or just keep existing order, here just assume newer is better but we don't change timestamp)
                        return b.timestamp - a.timestamp; 
                    });

                    // Reset to page 1 to see the updated item at top
                    currentPage = 1;
                    showToast('已加入解析队列', 'success');
                } else {
                    showToast('修改已保存', 'success');
                }
                
                renderKPTable();
                closeEditModal();
            }
        }

        // Mock Data Generation
        function generateMockData(targetCount = 50) {
            const baseNames = ['技术规范', '用户手册', '接口文档', '测试报告', '需求分析', '架构设计', '部署指南', '运维手册'];
            const prefixes = ['8K超高清', '智能教学', '网络传输', '数据加密', '终端管理', '云平台', 'AI分析', '大数据'];
            
            const data = [];
            const now = Date.now();
            
            // Helper to create item
            const createItem = (i, statusObj, timeOffset) => {
                const prefix = prefixes[Math.floor(Math.random() * prefixes.length)];
                const base = baseNames[Math.floor(Math.random() * baseNames.length)];
                const ext = Math.random() > 0.8 ? '.docx' : '.pdf';
                const timestamp = now - timeOffset;
                
                const method = Math.random() > 0.5 ? 'MinerU' : (Math.random() > 0.5 ? 'Dots' : 'General');
                const chunkStrategy = Math.random() > 0.7 ? '固定大小' : '智能分块';
                
                return {
                    id: i + 1,
                    name: `${prefix}${base}_v${(Math.random() * 5).toFixed(1)}${ext}`,
                    chunk: Math.floor(Math.random() * 200),
                    date: new Date(timestamp).toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '/'),
                    timestamp: timestamp,
                    method: method,
                    chunkStrategy: chunkStrategy,
                    chunkSize: chunkStrategy === '固定大小' ? (Math.floor(Math.random() * 500) + 100) : 256,
                    maxChunkSize: chunkStrategy === '智能分块' ? (Math.floor(Math.random() * 1000) + 500) : 1024,
                    minChunkSize: 10,
                    enabled: statusObj.enabled,
                    status: statusObj.text,
                    statusColor: statusObj.color,
                    retry: statusObj.retry || false
                };
            };

            // Parsing Status Logic:
            // 1. If 'Pending' > 0 -> Must have exactly 1 'Processing'
            // 2. If 'Pending' == 0 -> 'Processing' can be 0 or 1
            
            // Decide Pending count (0 to 3)
            const pendingCount = Math.floor(Math.random() * 4);
            let processingCount = 0;
            
            if (pendingCount > 0) {
                processingCount = 1;
            } else {
                processingCount = Math.random() > 0.7 ? 1 : 0;
            }
            
            // Decide Failed count (0 to 3)
            const failedCount = Math.floor(Math.random() * 4);
            
            // Calculate Success count
            // Ensure at least 0
            let successCount = targetCount - pendingCount - processingCount - failedCount;
            if (successCount < 0) {
                // Adjust if total is small
                successCount = 0;
                // We might exceed targetCount slightly if target is very small (e.g. 2), but that's edge case.
                // Priority: Status Logic > Exact Count match if conflict (though rare with typical counts)
            }
            
            let currentIndex = 0;

            // 1. Generate Pending Items
            for (let i = 0; i < pendingCount; i++) {
                 data.push(createItem(currentIndex++, { text: '待解析', color: 'bg-green-100 text-green-600 border-green-200', enabled: false }, i * 1000));
            }
            
            // 2. Generate Processing Items
            for (let i = 0; i < processingCount; i++) {
                 data.push(createItem(currentIndex++, { text: '解析中', color: 'bg-orange-100 text-orange-600 border-orange-200', enabled: false }, (pendingCount + i) * 1000));
            }
            
            // 3. Generate Failed Items
             for (let i = 0; i < failedCount; i++) {
                 data.push(createItem(currentIndex++, { text: '解析失败', color: 'bg-red-100 text-red-600 border-red-200', enabled: false, retry: true }, (pendingCount + processingCount + i) * 1000));
            }
            
            // 4. Generate Success Items
            const successStatuses = [
                { text: '解析成功', color: 'bg-blue-100 text-blue-600 border-blue-200', enabled: true },
                { text: '解析成功', color: 'bg-blue-100 text-blue-600 border-blue-200', enabled: false }
            ];
            
            for (let i = 0; i < successCount; i++) {
                const status = successStatuses[Math.floor(Math.random() * successStatuses.length)];
                // Random time in the past
                const timeOffset = 100000 + Math.floor(Math.random() * 1000000000); 
                data.push(createItem(currentIndex++, status, timeOffset));
            }
            
            // Sort: Pending > Processing > Others, then by Date Descending
            return data.sort((a, b) => {
                const getStatusPriority = (status) => {
                    if (status === '待解析') return 0;
                    if (status === '解析中') return 1;
                    return 2;
                };

                const priorityA = getStatusPriority(a.status);
                const priorityB = getStatusPriority(b.status);

                if (priorityA !== priorityB) {
                    return priorityA - priorityB;
                }
                
                return b.timestamp - a.timestamp;
            });
        }

        // Filtering & Pagination Logic
        function getFilteredData() {
            return kpList.filter(item => {
                const statusMatch = currentFilter.status === '全部' || 
                                   (currentFilter.status === '已启用' && item.enabled) ||
                                   (currentFilter.status === '未启用' && !item.enabled);
                const keywordMatch = item.name.toLowerCase().includes(currentFilter.keyword.toLowerCase());
                return statusMatch && keywordMatch;
            });
        }

        function getCurrentPageData() {
            const filtered = getFilteredData();
            const start = (currentPage - 1) * pageSize;
            const end = start + parseInt(pageSize);
            return filtered.slice(start, end);
        }

        // --- 3. Rendering ---

        // Render KP Table (Tab 1)
        function renderKPTable() {
            const data = getCurrentPageData();
            const tbody = document.getElementById('kp-table-body');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-10 text-gray-500">暂无数据</td></tr>';
            } else {
                data.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 transition-colors group';
                    tr.innerHTML = `
                        <td class="px-4 py-4 text-center sticky left-0 z-10 bg-white group-hover:bg-gray-50 transition-colors">
                            <input type="checkbox" onchange="toggleSelection(${item.id}, this.checked)" ${selectedIds.has(item.id) ? 'checked' : ''} class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4 cursor-pointer">
                        </td>
                        <td class="px-4 py-4 sticky left-12 z-10 bg-white group-hover:bg-gray-50 shadow-[5px_0_5px_-5px_rgba(0,0,0,0.1)] transition-colors">
                            ${item.status === '解析成功' 
                                ? `<a href="knowledge-parsing.html?file=${encodeURIComponent(item.name)}&kb=${encodeURIComponent(document.getElementById('kb-title').textContent)}" class="text-blue-600 hover:underline font-medium break-all line-clamp-2" title="${item.name}">${item.name}</a>`
                                : `<span class="text-gray-700 font-medium break-all line-clamp-2" title="${item.name}">${item.name}</span>`
                            }
                        </td>
                        <td class="px-4 py-4 text-center text-gray-600">${item.status === '解析成功' ? item.chunk : '-'}</td>
                        <td class="px-4 py-4 text-center text-gray-500 text-xs font-mono">${item.date}</td>
                        <td class="px-4 py-4 text-center text-gray-600 text-xs">${item.method}</td>
                        <td class="px-4 py-4 text-center">
                            <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in ${item.status !== '解析成功' ? 'opacity-50 cursor-not-allowed' : ''}">
                                <input type="checkbox" id="kp-toggle-${item.id}" onclick="toggleKPStatus(${item.id})" ${item.enabled ? 'checked' : ''} ${item.status !== '解析成功' ? 'disabled' : ''} class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none ${item.status !== '解析成功' ? 'cursor-not-allowed' : 'cursor-pointer'} border-gray-300 transition-all duration-300"/>
                                <label for="kp-toggle-${item.id}" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 ${item.status !== '解析成功' ? 'cursor-not-allowed' : 'cursor-pointer'} transition-colors duration-300"></label>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-left">
                            <div class="flex items-center justify-start gap-3">
                                <span class="inline-flex items-center px-2.5 py-1 rounded border text-xs font-medium ${item.statusColor}">
                                    ${item.status}
                                </span>
                                ${item.status === '解析失败' ? `<button onclick="retryParsing(${item.id})" class="text-gray-400 hover:text-blue-600 transition-colors" title="重试"><i class="fas fa-redo text-xs"></i></button>` : ''}
                            </div>
                        </td>
                        <td class="px-4 py-4 text-center sticky right-0 bg-white group-hover:bg-gray-50 z-10 shadow-[-5px_0_5px_-5px_rgba(0,0,0,0.1)] transition-colors">
                            <div class="flex items-center justify-center gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                <button ${item.status === '解析中' ? 'disabled' : `onclick="openEditModal(${item.id})"`} class="w-8 h-8 flex items-center justify-center rounded border ${item.status === '解析中' ? 'border-gray-200 bg-gray-100 text-gray-400 cursor-not-allowed' : 'border-green-200 bg-green-50 text-green-600 hover:bg-green-100 transition-colors'}" title="${item.status === '解析中' ? '解析中不可编辑' : '编辑'}">
                                    <i class="far fa-edit text-xs"></i>
                                </button>
                                <button onclick="deleteItem(${item.id})" class="w-8 h-8 flex items-center justify-center rounded border border-red-200 bg-red-50 text-red-600 hover:bg-red-100 transition-colors" title="删除">
                                    <i class="far fa-trash-alt text-xs"></i>
                                </button>
                                <button class="w-8 h-8 flex items-center justify-center rounded border border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors" title="下载">
                                    <i class="fas fa-download text-xs"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            renderPagination();
            updateSelectAllState();
        }

        // Render Pagination (Tab 1)
        function renderPagination() {
            const container = document.getElementById('kp-pagination-controls');
            const filtered = getFilteredData();
            const totalItems = filtered.length;
            const totalPages = Math.ceil(totalItems / pageSize);
            
            // Update total count separately
            document.getElementById('kp-total-count').textContent = `共 ${totalItems} 条`;
            
            let html = `
                <div class="relative group">
                    <select onchange="handlePageSizeChange(this.value)" class="appearance-none bg-white border border-gray-300 text-gray-700 py-1.5 pl-3 pr-8 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 transition-shadow">
                        <option value="8" ${pageSize == 8 ? 'selected' : ''}>8条/页</option>
                        <option value="10" ${pageSize == 10 ? 'selected' : ''}>10条/页</option>
                        <option value="20" ${pageSize == 20 ? 'selected' : ''}>20条/页</option>
                        <option value="50" ${pageSize == 50 ? 'selected' : ''}>50条/页</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400 group-hover:text-blue-500 transition-colors">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>

                <div class="flex items-center space-x-1">
                    <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''} class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left text-xs"></i>
                    </button>
            `;

            // Logic to show pages with ellipsis
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    const isActive = i === currentPage;
                    html += `
                        <button onclick="changePage(${i})" class="w-8 h-8 flex items-center justify-center rounded border ${isActive ? 'border-blue-500 bg-blue-500 text-white font-medium shadow-sm' : 'border-gray-300 bg-white text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors'}">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    html += `<span class="w-8 h-8 flex items-center justify-center text-gray-400">...</span>`;
                }
            }

            html += `
                    <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                </div>
                
                <div class="flex items-center text-sm text-gray-600 ml-2">
                    <span class="mr-2">跳至</span>
                    <input type="number" min="1" max="${totalPages}" onchange="changePage(this.value)" class="w-10 h-8 border border-gray-300 rounded text-center focus:outline-none focus:ring-1 focus:ring-blue-500 mx-1 transition-shadow" value="${currentPage}">
                    <span class="ml-1">页</span>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function changePage(page) {
            const filtered = getFilteredData();
            const totalPages = Math.ceil(filtered.length / pageSize);
            page = parseInt(page);
            if (isNaN(page) || page < 1 || (totalPages > 0 && page > totalPages) || page === currentPage) return;
            currentPage = page;
            renderKPTable();
            // renderPagination is called inside renderKPTable
        }

        function handlePageSizeChange(size) {
            pageSize = parseInt(size);
            currentPage = 1;
            renderKPTable();
        }

        // Render Attachments (Tab 2) - Keep static for now as requested primarily for KP management
        // Attachment State
        let attachList = [
            { id: 101, name: '8K超高清公共显示传播系统组成框图.png', desc: '8K超高清公共显示传播系统由以下几个部分组成：1. 8K超高清节目制作系统：主要负责制作生产8K超高清节目。2. 8K超高清节目播控平台：...', date: '2024/04/05 11:04:28', keywords: '8k超高清,传播系统,组成框图', type: '图片' },
            { id: 102, name: '8K超高清节目播控平台组成示意图.png', desc: '8K超高清节目播控平台组成示意图如图3所示。', date: '2024/04/05 11:04:28', keywords: '8K超高清公共显示传播系统技术规范,8K超高清节目播控平台系统架构', type: '图片' },
            { id: 103, name: '超高清视音频组播传输网络.png', desc: '1. 组播传输网络 组播传输网络将直播播出信号以组播方式传输到公共显示接收终端。', date: '2024/04/05 11:04:28', keywords: '8K超高清公共显示传播系统技术规范,超高清视音频组播传输网络', type: '图片' },
            { id: 104, name: '超高清视音频单播传输网络.png', desc: '1. 单播传输网络 单播传输网络将直播节目播出信号以单播方式传输到公共显示接收终端，可采用光传输网络或5G移动通讯网络。', date: '2024/04/05 11:04:28', keywords: '8K超高清公共显示传播系统技术规范,超高清视音频单播传输网络', type: '图片' },
            { id: 105, name: '播出业务数据传输网络.png', desc: '1. 文件传输网络 文件传输网络将播出视音频文件、播出单传输至公共显示接收终端，并提供播控平台对接的接收终端管理与控制的网络服务。文件传输网络如图6所示。', date: '2024/04/05 11:04:28', keywords: '8K超高清公共显示传播系统技术规范文件传输网络', type: '图片' },
            { id: 106, name: '接收终端管理与控制.png', desc: '1. 接收终端管理与控制系统 提供接收终端管理与控制的网络服务，确保终端的正常运行和维护。', date: '2024/04/05 11:04:28', keywords: '8K超高清公共显示传播系统技术规范,接收终端管理与控制', type: '图片' },
            { id: 107, name: '功能演示视频.mp4', desc: '演示系统主要功能的视频教程。', date: '2024/04/08 10:00:00', keywords: '演示,视频', type: '视频' },
            { id: 108, name: '系统安装教学视频.mp4', desc: '详细讲解系统安装步骤的视频教程。', date: '2024/04/08 14:30:00', keywords: '安装,教程,视频', type: '视频' },
            { id: 109, name: '故障排查指南视频.mp4', desc: '常见故障排查与解决方法的视频演示。', date: '2024/04/09 09:15:00', keywords: '故障排查,视频', type: '视频' },
            { id: 110, name: '新功能特性介绍.mp4', desc: '介绍最新版本系统的新增功能和特性。', date: '2024/04/10 16:20:00', keywords: '新功能,介绍,视频', type: '视频' },
        ];
        
        let currentAttachFilter = {
            type: '全部',
            keyword: ''
        };
        let currentAttachPage = 1;
        let attachPageSize = 8;

        function getFilteredAttachData() {
            return attachList.filter(item => {
                const matchType = currentAttachFilter.type === '全部' || item.type === currentAttachFilter.type;
                const matchKeyword = !currentAttachFilter.keyword || 
                                   item.name.toLowerCase().includes(currentAttachFilter.keyword.toLowerCase()) || 
                                   item.desc.toLowerCase().includes(currentAttachFilter.keyword.toLowerCase()) ||
                                   item.keywords.toLowerCase().includes(currentAttachFilter.keyword.toLowerCase());
                return matchType && matchKeyword;
            });
        }

        function renderAttachTable() {
            const attachBody = document.getElementById('attach-table-body');
            attachBody.innerHTML = '';
            
            const filtered = getFilteredAttachData();
            const start = (currentAttachPage - 1) * attachPageSize;
            const end = start + attachPageSize;
            const pageData = filtered.slice(start, end);
            
            renderAttachPagination(filtered.length);
            
            // Reset header checkbox
            const headerCheckbox = document.getElementById('attach-select-all-header');
            const footerCheckbox = document.getElementById('attach-select-all-footer');
            if (headerCheckbox) headerCheckbox.checked = false;
            if (footerCheckbox) footerCheckbox.checked = false;

            if (pageData.length === 0) {
                attachBody.innerHTML = '<tr><td colspan="7" class="text-center py-8 text-gray-500">暂无数据</td></tr>';
                return;
            }

            pageData.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors group';
                tr.innerHTML = `
                    <td class="px-4 py-4 text-center sticky left-0 z-10 bg-white group-hover:bg-gray-50 transition-colors">
                        <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 h-4 w-4 cursor-pointer">
                    </td>
                    <td class="px-4 py-8 sticky left-12 z-10 bg-white group-hover:bg-gray-50 shadow-[5px_0_5px_-5px_rgba(0,0,0,0.1)] transition-colors">
                        <a href="#" class="text-blue-600 hover:underline font-medium break-all line-clamp-2" title="${item.name}">${item.name}</a>
                    </td>
                    <td class="px-4 py-8">
                        <p class="text-gray-500 text-xs leading-loose line-clamp-2 break-words" title="${item.desc}">${item.desc}</p>
                    </td>
                    <td class="px-4 py-8 text-center text-gray-500 text-xs font-mono whitespace-nowrap">${item.date}</td>
                    <td class="px-4 py-8">
                        <p class="text-gray-500 text-xs break-all">${item.keywords}</p>
                    </td>
                    <td class="px-4 py-8 text-center text-gray-600 text-xs">${item.type}</td>
                    <td class="px-4 py-8 text-center sticky right-0 bg-white group-hover:bg-gray-50 z-10 shadow-[-5px_0_5px_-5px_rgba(0,0,0,0.1)] transition-colors">
                        <div class="flex items-center justify-center gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                            <button onclick="openAttachEditModal(${item.id})" class="w-8 h-8 flex items-center justify-center rounded border border-green-200 bg-green-50 text-green-600 hover:bg-green-100 transition-colors" title="编辑">
                                <i class="far fa-edit text-xs"></i>
                            </button>
                            <button onclick="deleteAttachItem(${item.id})" class="w-8 h-8 flex items-center justify-center rounded border border-red-200 bg-red-50 text-red-600 hover:bg-red-100 transition-colors" title="删除">
                                <i class="far fa-trash-alt text-xs"></i>
                            </button>
                            <button class="w-8 h-8 flex items-center justify-center rounded border border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-100 transition-colors" title="下载">
                                <i class="fas fa-download text-xs"></i>
                            </button>
                        </div>
                    </td>
                `;
                attachBody.appendChild(tr);
            });
        }

        function renderAttachPagination(totalItems) {
            const container = document.getElementById('attach-pagination-controls');
            const totalPages = Math.ceil(totalItems / attachPageSize);
            
            // Update total count
            document.getElementById('attach-total-count').textContent = `共 ${totalItems} 条`;
            
            let html = `
                <div class="relative group">
                    <select onchange="handleAttachPageSizeChange(this.value)" class="appearance-none bg-white border border-gray-300 text-gray-700 py-1.5 pl-3 pr-8 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500 transition-shadow">
                        <option value="8" ${attachPageSize == 8 ? 'selected' : ''}>8条/页</option>
                        <option value="10" ${attachPageSize == 10 ? 'selected' : ''}>10条/页</option>
                        <option value="20" ${attachPageSize == 20 ? 'selected' : ''}>20条/页</option>
                        <option value="50" ${attachPageSize == 50 ? 'selected' : ''}>50条/页</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400 group-hover:text-blue-500 transition-colors">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>

                <div class="flex items-center space-x-1">
                    <button onclick="changeAttachPage(${currentAttachPage - 1})" ${currentAttachPage === 1 ? 'disabled' : ''} class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-left text-xs"></i>
                    </button>
            `;

            // Logic to show pages with ellipsis
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentAttachPage - 1 && i <= currentAttachPage + 1)) {
                    const isActive = i === currentAttachPage;
                    html += `
                        <button onclick="changeAttachPage(${i})" class="w-8 h-8 flex items-center justify-center rounded border ${isActive ? 'border-blue-500 bg-blue-500 text-white font-medium shadow-sm' : 'border-gray-300 bg-white text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors'}">
                            ${i}
                        </button>
                    `;
                } else if (i === currentAttachPage - 2 || i === currentAttachPage + 2) {
                    html += `<span class="w-8 h-8 flex items-center justify-center text-gray-400">...</span>`;
                }
            }

            html += `
                    <button onclick="changeAttachPage(${currentAttachPage + 1})" ${currentAttachPage === totalPages || totalPages === 0 ? 'disabled' : ''} class="w-8 h-8 flex items-center justify-center rounded border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-chevron-right text-xs"></i>
                    </button>
                </div>
                
                <div class="flex items-center text-sm text-gray-600 ml-2">
                    <span class="mr-2">跳至</span>
                    <input type="number" min="1" max="${totalPages}" onchange="changeAttachPage(this.value)" class="w-10 h-8 border border-gray-300 rounded text-center focus:outline-none focus:ring-1 focus:ring-blue-500 mx-1 transition-shadow" value="${currentAttachPage}">
                    <span class="ml-1">页</span>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function changeAttachPage(page) {
            const filtered = getFilteredAttachData();
            const totalPages = Math.ceil(filtered.length / attachPageSize);
            page = parseInt(page);
            if (isNaN(page) || page < 1 || (totalPages > 0 && page > totalPages) || page === currentAttachPage) return;
            currentAttachPage = page;
            renderAttachTable();
        }

        function handleAttachPageSizeChange(size) {
            attachPageSize = parseInt(size);
            currentAttachPage = 1;
            renderAttachTable();
        }

        function handleAttachSearch() {
            const keyword = document.getElementById('attach-search-input').value;
            currentAttachFilter.keyword = keyword;
            currentAttachPage = 1;
            renderAttachTable();
        }

        function handleAttachReset() {
            document.getElementById('attach-search-input').value = '';
            currentAttachFilter.type = '全部';
            document.getElementById('attach-type-select-text').textContent = '全部';
            currentAttachFilter.keyword = '';
            currentAttachPage = 1;
            renderAttachTable();
        }

        function toggleAttachSelectAll(checked) {
            const checkboxes = document.querySelectorAll('#attach-table-body input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = checked);
            const headerCheckbox = document.getElementById('attach-select-all-header');
            const footerCheckbox = document.getElementById('attach-select-all-footer');
            if (headerCheckbox) headerCheckbox.checked = checked;
            if (footerCheckbox) footerCheckbox.checked = checked;
        }

        // --- Attachment CRUD Operations ---

        // 1. Upload
        let currentAttachFile = null;

        function openAttachUploadModal() {
            const modal = document.getElementById('attach-upload-modal');
            const content = document.getElementById('attach-upload-modal-content');
            
            // Reset Form
            document.getElementById('attach-upload-file-input').value = '';
            document.getElementById('attach-upload-file-name').value = '';
            document.getElementById('attach-upload-desc').value = '';
            document.getElementById('attach-upload-keywords').value = '';
            
            const uploadText = document.getElementById('attach-upload-text');
            if (uploadText) {
                uploadText.textContent = '点击或拖拽文件到此处上传';
                uploadText.classList.remove('text-blue-600', 'font-bold');
            }
            
            const dropZone = document.getElementById('attach-upload-drop-zone');
            if (dropZone) {
                dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            }
            
            currentAttachFile = null;
            
            // Reset Progress
            document.getElementById('attach-upload-state-normal').classList.remove('hidden');
            document.getElementById('attach-upload-state-progress').classList.add('hidden');
            document.getElementById('attach-upload-progress-bar').style.width = '0%';
            document.getElementById('attach-upload-progress-text').textContent = '0%';
            
            // Reset Buttons
            const btnStart = document.getElementById('btn-start-attach-upload');
            const btnCancel = document.getElementById('btn-cancel-attach-upload');
            if (btnStart) {
                btnStart.disabled = false;
                btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
                btnStart.textContent = '开始上传';
            }
            if (btnCancel) btnCancel.disabled = false;
            
            modal.classList.remove('hidden');
            // Trigger reflow
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }

        function closeAttachUploadModal() {
            const modal = document.getElementById('attach-upload-modal');
            const content = document.getElementById('attach-upload-modal-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function handleAttachUploadFile(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate File Type (Image or Video only)
            const validTypes = ['image/', 'video/'];
            const isValid = validTypes.some(type => file.type.startsWith(type));

            if (!isValid) {
                showToast('请上传图片或视频文件', 'error');
                input.value = ''; // Clear input
                return;
            }

            currentAttachFile = file;
            const nameInput = document.getElementById('attach-upload-file-name');
            if (!nameInput.value.trim()) {
                // Get name without extension
                const fileName = file.name;
                const lastDotIndex = fileName.lastIndexOf('.');
                const nameWithoutExt = lastDotIndex !== -1 ? fileName.substring(0, lastDotIndex) : fileName;
                nameInput.value = nameWithoutExt;
            }
            
            // Update UI
            const uploadText = document.getElementById('attach-upload-text');
            uploadText.textContent = `已选择: ${file.name}`;
            uploadText.classList.add('text-blue-600', 'font-bold');
            
            document.getElementById('attach-upload-drop-zone').classList.add('border-blue-500', 'bg-blue-50');
        }

        function startAttachUpload() {
            const name = document.getElementById('attach-upload-file-name').value;
            const desc = document.getElementById('attach-upload-desc').value;
            const keywords = document.getElementById('attach-upload-keywords').value;

            if (!currentAttachFile) {
                showToast('请先选择上传文件', 'error');
                return;
            }
            
            if (!name) {
                showToast('文件名不能为空', 'error');
                return;
            }

            if (!keywords) {
                showToast('关键词不能为空', 'error');
                return;
            }

            // UI Update
            document.getElementById('attach-upload-state-normal').classList.add('hidden');
            document.getElementById('attach-upload-state-progress').classList.remove('hidden');
            
            const btnStart = document.getElementById('btn-start-attach-upload');
            const btnCancel = document.getElementById('btn-cancel-attach-upload');
            btnStart.disabled = true;
            btnStart.classList.add('opacity-50', 'cursor-not-allowed');
            btnStart.textContent = '上传中...';
            btnCancel.disabled = true;

            // Simulate Progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress > 100) progress = 100;
                
                document.getElementById('attach-upload-progress-bar').style.width = `${progress}%`;
                document.getElementById('attach-upload-progress-text').textContent = `${Math.round(progress)}%`;
                
                if (progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        // Append extension if file exists
                        let finalName = name;
                        if (currentAttachFile) {
                            const lastDotIndex = currentAttachFile.name.lastIndexOf('.');
                            if (lastDotIndex !== -1) {
                                const ext = currentAttachFile.name.substring(lastDotIndex);
                                if (!finalName.endsWith(ext)) {
                                    finalName += ext;
                                }
                            }
                        }

                        // Add to list
                        const newItem = {
                            id: Date.now(),
                            name: finalName,
                            desc: desc || '无描述',
                            date: new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '/'),
                            keywords: keywords || '无关键词',
                            type: currentAttachFile && currentAttachFile.type.startsWith('video/') ? '视频' : '图片'
                        };
                        
                        attachList.unshift(newItem); // Add to top
                        renderAttachTable();
                        
                        showToast('附件已成功上传', 'success');
                        closeAttachUploadModal();
                    }, 500);
                }
            }, 200);
        }

        // 2. Edit
        function openAttachEditModal(id) {
            const item = attachList.find(i => i.id === id);
            if (!item) return;
            
            document.getElementById('attach-edit-id').value = item.id;
            
            // Separate Name and Extension
            const fileName = item.name;
            const lastDotIndex = fileName.lastIndexOf('.');
            let nameWithoutExt = fileName;
            let ext = '';
            
            if (lastDotIndex !== -1) {
                nameWithoutExt = fileName.substring(0, lastDotIndex);
                ext = fileName.substring(lastDotIndex);
            }
            
            document.getElementById('attach-edit-name').value = nameWithoutExt;
            document.getElementById('attach-edit-ext').value = ext;
            
            document.getElementById('attach-edit-desc').value = item.desc;
            document.getElementById('attach-edit-keywords').value = item.keywords;
            
            const modal = document.getElementById('attach-edit-modal');
            const content = document.getElementById('attach-edit-modal-content');
            
            modal.classList.remove('hidden');
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }

        function closeAttachEditModal() {
            const modal = document.getElementById('attach-edit-modal');
            const content = document.getElementById('attach-edit-modal-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function saveAttachEdit() {
            const id = parseInt(document.getElementById('attach-edit-id').value);
            let name = document.getElementById('attach-edit-name').value;
            const ext = document.getElementById('attach-edit-ext').value;
            const desc = document.getElementById('attach-edit-desc').value;
            const keywords = document.getElementById('attach-edit-keywords').value;
            
            if (!name) {
                showToast('文件名不能为空', 'error');
                return;
            }
            
            // Append extension if not already present (user might have added it manually, but we handle that case simply)
            // Or better: just always append the stored extension if name doesn't end with it?
            // User instruction says: "display name without suffix", "list shows name+suffix".
            // So we assume the input is the name part.
            if (ext && !name.endsWith(ext)) {
                name += ext;
            }
            
            const item = attachList.find(i => i.id === id);
            if (item) {
                item.name = name;
                item.desc = desc;
                item.keywords = keywords;
                
                renderAttachTable();
                showToast('附件信息已更新', 'success');
                closeAttachEditModal();
            }
        }

        // 3. Delete
        let attachIdToDelete = null;

        function deleteAttachItem(id) {
            attachIdToDelete = id;
            const modal = document.getElementById('attach-delete-modal');
            const content = document.getElementById('attach-delete-modal-content');
            
            modal.classList.remove('hidden');
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }

        function closeAttachDeleteModal() {
            attachIdToDelete = null;
            const modal = document.getElementById('attach-delete-modal');
            const content = document.getElementById('attach-delete-modal-content');
            
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function confirmAttachDelete() {
            if (attachIdToDelete) {
                attachList = attachList.filter(item => item.id !== attachIdToDelete);
                
                // Adjust pagination if needed
                const totalPages = Math.ceil(attachList.length / attachPageSize);
                if (currentAttachPage > totalPages && currentAttachPage > 1) {
                    currentAttachPage = totalPages;
                }
                
                renderAttachTable();
                showToast('附件已删除', 'success');
                closeAttachDeleteModal();
            }
        }

        // --- 4. Event Handlers ---
        
        // Custom Dropdown Logic
        function setupDropdown(idPrefix, options, onSelect) {
            const btn = document.getElementById(`${idPrefix}-select-btn`);
            const menu = document.getElementById(`${idPrefix}-options`);
            const text = document.getElementById(`${idPrefix}-select-text`);
            const icon = document.getElementById(`${idPrefix}-select-icon`);
            const defaultText = text.textContent;

            // Render options
            menu.innerHTML = '';
            
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'px-4 py-2 hover:bg-gray-50 cursor-pointer text-sm text-gray-700 transition-colors';
                div.setAttribute('data-value', opt);
                div.textContent = opt;
                menu.appendChild(div);
            });

            // Toggle
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const isHidden = menu.classList.contains('hidden');
                // Close others
                document.querySelectorAll('[id$="-options"]').forEach(el => {
                    if (el !== menu) el.classList.add('hidden');
                });
                
                if (isHidden) {
                    menu.classList.remove('hidden');
                    void menu.offsetWidth;
                    menu.classList.remove('opacity-0', 'scale-95');
                    icon.classList.add('rotate-180');
                } else {
                    closeDropdown(menu, icon);
                }
            });

            // Select
            menu.addEventListener('click', (e) => {
                e.stopPropagation();
                const option = e.target.closest('div[data-value]');
                if (!option) return;
                
                const value = option.getAttribute('data-value');
                onSelect(value);
                
                text.textContent = value;
                text.classList.toggle('text-gray-700', !!value); 
                closeDropdown(menu, icon);
            });
        }

        function closeDropdown(menu, icon) {
            menu.classList.add('opacity-0', 'scale-95');
            icon.classList.remove('rotate-180');
            setTimeout(() => {
                menu.classList.add('hidden');
            }, 200);
        }

        // Upload Logic
        function handleUploadFile(input) {
            const file = input.files[0];
            if (file) {
                // Validation
                const validExtensions = ['.pdf', '.doc', '.docx', '.txt', '.md', '.markdown'];
                const fileName = file.name.toLowerCase();
                const isValid = validExtensions.some(ext => fileName.endsWith(ext));
                
                if (!isValid) {
                    showToast('不支持的文件格式，请上传 PDF, Word, TXT, Markdown', 'error');
                    input.value = ''; // Clear input
                    return;
                }

                // Auto-fill filename without extension
                const lastDotIndex = file.name.lastIndexOf('.');
                const nameWithoutExt = lastDotIndex !== -1 ? file.name.substring(0, lastDotIndex) : file.name;
                const nameInput = document.getElementById('upload-file-name');
                if (!nameInput.value.trim()) {
                    nameInput.value = nameWithoutExt;
                }
                document.getElementById('upload-text').textContent = file.name;
                document.getElementById('upload-text').classList.add('text-blue-600', 'font-bold');
                
                // Add highlight style to indicate success
                const dropZone = document.getElementById('upload-drop-zone');
                dropZone.classList.add('border-blue-500', 'bg-blue-50');
            }
        }

        // Modal Logic
        function openUploadModal() {
            const modal = document.getElementById('upload-modal');
            const content = document.getElementById('upload-modal-content');
            
            // Reset Form
            document.getElementById('upload-file-input').value = '';
            document.getElementById('upload-file-name').value = '';
            document.getElementById('upload-text').textContent = '点击或拖拽文件到此处上传';
            document.getElementById('upload-text').classList.remove('text-blue-600', 'font-bold');
            document.getElementById('upload-drop-zone').classList.remove('border-blue-500', 'bg-blue-50');
            
            // Reset Progress
            document.getElementById('upload-state-normal').classList.remove('hidden');
            document.getElementById('upload-state-progress').classList.add('hidden');
            document.getElementById('upload-progress-bar').style.width = '0%';
            document.getElementById('upload-progress-text').textContent = '0%';
            
            // Reset Dropdowns and Inputs
            selectCustomOption('upload-method', 'MinerU');
            
            // Apply Config Defaults
            selectCustomOption('upload-strategy', kbConfig.strategy);
            
            document.getElementById('upload-max-chunk-size').value = kbConfig.maxChunkSize;
            document.getElementById('upload-min-chunk-size').value = kbConfig.minChunkSize;
            document.getElementById('upload-chunk-size').value = kbConfig.maxChunkSize; // Use max chunk for fixed as well

            // Ensure inputs visibility is correct
            toggleUploadChunkSizeInput();

            // Reset Buttons
            const btnStart = document.getElementById('btn-start-upload');
            const btnCancel = document.getElementById('btn-cancel-upload');
            if (btnStart) {
                btnStart.disabled = false;
                btnStart.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            if (btnCancel) btnCancel.disabled = false;

            modal.classList.remove('hidden');
            // Trigger reflow
            void modal.offsetWidth;
            modal.classList.remove('opacity-0');
            content.classList.remove('scale-95');
        }

        function startUpload() {
            const fileName = document.getElementById('upload-file-name').value.trim();
            const method = document.getElementById('upload-method-input').value;
            const strategy = document.getElementById('upload-strategy-input').value;
            const maxChunk = parseInt(document.getElementById('upload-max-chunk-size').value);
            const minChunk = parseInt(document.getElementById('upload-min-chunk-size').value);
            const fixedChunk = parseInt(document.getElementById('upload-chunk-size').value);
            const fileInput = document.getElementById('upload-file-input');

            if (!fileInput.files || !fileInput.files[0]) {
                showToast('请先选择上传文件', 'error');
                return;
            }

            if (!fileName) {
                showToast('请输入文件名称', 'error');
                return;
            }
            
            // UI State Change
            const btnStart = document.getElementById('btn-start-upload');
            const btnCancel = document.getElementById('btn-cancel-upload');
            btnStart.disabled = true;
            btnCancel.disabled = true;
            btnStart.classList.add('opacity-50', 'cursor-not-allowed');
            
            // Show Progress
            document.getElementById('upload-state-normal').classList.add('hidden');
            const progressState = document.getElementById('upload-state-progress');
            progressState.classList.remove('hidden');
            
            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-progress-text');
            
            // Simulate Upload
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.floor(Math.random() * 10) + 5;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${progress}%`;
                
                if (progress === 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        // Append extension if file exists
                        let finalName = fileName;
                        if (fileInput.files[0]) {
                            const file = fileInput.files[0];
                            const lastDotIndex = file.name.lastIndexOf('.');
                            if (lastDotIndex !== -1) {
                                const ext = file.name.substring(lastDotIndex);
                                if (!finalName.endsWith(ext)) {
                                    finalName += ext;
                                }
                            }
                        }

                        // Finish
                        finishUpload({ fileName: finalName, method, strategy, maxChunk, minChunk, fixedChunk });
                    }, 500);
                }
            }, 200);
        }

        function finishUpload(data) {
            // Create New Item
            const newItem = {
                id: Date.now(), // Unique ID
                name: data.fileName,
                status: '待解析',
                statusColor: 'bg-green-100 text-green-600 border-green-200',
                date: new Date().toLocaleString('zh-CN', { hour12: false }).replace(/\//g, '/'),
                timestamp: Date.now(),
                enabled: false,
                method: data.method,
                chunkStrategy: data.strategy,
                maxChunkSize: data.strategy === '智能分块' ? data.maxChunk : undefined,
                minChunkSize: data.strategy === '智能分块' ? data.minChunk : undefined,
                chunkSize: data.strategy === '固定大小' ? data.fixedChunk : undefined
            };
            
            kpList.unshift(newItem);
            
            // Re-sort to ensure correct order
            kpList.sort((a, b) => {
                const getStatusPriority = (status) => {
                    if (status === '待解析') return 0;
                    if (status === '解析中') return 1;
                    return 2;
                };
                const priorityA = getStatusPriority(a.status);
                const priorityB = getStatusPriority(b.status);
                if (priorityA !== priorityB) return priorityA - priorityB;
                return b.timestamp - a.timestamp;
            });
            
            currentPage = 1;
            renderKPTable();
            closeUploadModal();
            showToast('文件上传并添加到解析队列成功', 'success');
        }

        function closeUploadModal() {
            const modal = document.getElementById('upload-modal');
            const content = document.getElementById('upload-modal-content');
            modal.classList.add('opacity-0');
            content.classList.add('scale-95');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 200);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-msg');
            const title = toast.querySelector('h4');
            const iconContainer = toast.querySelector('div:first-child');
            const icon = iconContainer.querySelector('i');

            // Reset classes
            toast.classList.remove('border-green-100', 'border-red-100');
            iconContainer.classList.remove('bg-green-100', 'text-green-500', 'bg-red-100', 'text-red-500');
            icon.classList.remove('fa-check', 'fa-times');

            if (type === 'success') {
                toast.classList.add('border-green-100');
                iconContainer.classList.add('bg-green-100', 'text-green-500');
                icon.classList.add('fa-check');
                title.textContent = '操作成功';
            } else {
                toast.classList.add('border-red-100');
                iconContainer.classList.add('bg-red-100', 'text-red-500');
                icon.classList.add('fa-times');
                title.textContent = '操作失败';
            }

            msg.textContent = message;
            toast.classList.remove('translate-x-[120%]');
            setTimeout(() => {
                toast.classList.add('translate-x-[120%]');
            }, 3000);
        }

        function handleSearch() {
            const keyword = document.getElementById('kp-search-input').value;
            // Status is already updated in currentFilter via dropdown callback
            currentFilter.keyword = keyword;
            currentPage = 1;
            renderKPTable();
        }

        function handleReset() {
            document.getElementById('kp-search-input').value = '';
            
            // Reset Dropdown
            currentFilter.status = '全部';
            document.getElementById('kp-status-select-text').textContent = '全部';
            
            currentFilter.keyword = '';
            currentPage = 1;
            renderKPTable();
        }

        function handlePageChange(page) {
            currentPage = page;
            renderKPTable();
        }

        function handlePageSizeChange(size) {
            pageSize = parseInt(size);
            currentPage = 1;
            renderKPTable();
        }

        function handleJumpPage(page) {
            const p = parseInt(page);
            const filtered = getFilteredData();
            const totalPages = Math.ceil(filtered.length / pageSize);
            if (!isNaN(p) && p >= 1 && p <= totalPages) {
                currentPage = p;
                renderKPTable();
            } else {
                // Optional: Show toast or alert
                document.getElementById('kp-jump-input').value = '';
            }
        }

        // --- 5. Init ---
        
        function setPageTitle() {
            const urlParams = new URLSearchParams(window.location.search);
            const kbName = urlParams.get('name');
            if (kbName) {
                document.getElementById('kb-title').textContent = decodeURIComponent(kbName);
                document.title = `${decodeURIComponent(kbName)} - 知识库详情`;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            kpList = generateMockData();
            renderKPTable();
            renderAttachTable();
            setPageTitle();

            // Setup Dropdown
            setupDropdown('kp-status', ['全部', '已启用', '未启用'], (val) => {
                currentFilter.status = val;
                handleSearch();
            });

            // Setup Attach Dropdown
            setupDropdown('attach-type', ['全部', '图片', '视频'], (val) => {
                currentAttachFilter.type = val;
                handleAttachSearch();
            });

            // Setup Upload Drag & Drop
            const dropZone = document.getElementById('upload-drop-zone');
            const fileInput = document.getElementById('upload-file-input');

            if (dropZone && fileInput) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, preventDefaults, false);
                });

                function preventDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZone.addEventListener(eventName, highlight, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, unhighlight, false);
                });

                function highlight(e) {
                    dropZone.classList.add('border-blue-500', 'bg-blue-50');
                }

                function unhighlight(e) {
                    dropZone.classList.remove('border-blue-500', 'bg-blue-50');
                }

                dropZone.addEventListener('drop', handleDrop, false);

                function handleDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length > 0) {
                        fileInput.files = files;
                        handleUploadFile(fileInput);
                    }
                }
            }

            // Setup Attachment Upload Drag & Drop
            const attachDropZone = document.getElementById('attach-upload-drop-zone');
            const attachFileInput = document.getElementById('attach-upload-file-input');

            if (attachDropZone && attachFileInput) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    attachDropZone.addEventListener(eventName, preventAttachDefaults, false);
                });

                function preventAttachDefaults(e) {
                    e.preventDefault();
                    e.stopPropagation();
                }

                ['dragenter', 'dragover'].forEach(eventName => {
                    attachDropZone.addEventListener(eventName, highlightAttach, false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    attachDropZone.addEventListener(eventName, unhighlightAttach, false);
                });

                function highlightAttach(e) {
                    attachDropZone.classList.add('border-blue-500', 'bg-blue-50');
                }

                function unhighlightAttach(e) {
                    attachDropZone.classList.remove('border-blue-500', 'bg-blue-50');
                }

                attachDropZone.addEventListener('drop', handleAttachDrop, false);

                function handleAttachDrop(e) {
                    const dt = e.dataTransfer;
                    const files = dt.files;
                    if (files.length > 0) {
                        attachFileInput.files = files;
                        handleAttachUploadFile(attachFileInput);
                    }
                }
            }

            // Global click to close dropdowns
            document.addEventListener('click', () => {
                document.querySelectorAll('[id$="-options"]').forEach(menu => {
                    if (!menu.classList.contains('hidden')) {
                        const iconId = menu.id.replace('options', 'select-icon');
                        closeDropdown(menu, document.getElementById(iconId));
                    }
                });
            });
            
            // Init Page
            init();
        });
        
        // --- Init ---
        function init() {
            // Init from URL first
            initPageFromUrl();
            
            // Only generate mock data if we haven't already (initPageFromUrl might trigger it)
            // But if initPageFromUrl runs simulateLoading, it will handle generation
            // If no ID is present (direct access?), we fallback to default behavior
            if (!currentKbId) {
                kpList = generateMockData();
                renderKPTable();
                renderAttachTable();
            }

            // Setup Dropdowns
            setupDropdown('kp-status', ['全部', '已启用', '未启用'], (val) => {
                currentFilter.status = val;
                currentPage = 1;
                renderKPTable();
            });

            setupDropdown('attach-type', ['全部', '图片', '视频', '文档', '压缩包'], (val) => {
                currentAttachFilter.type = val;
                currentAttachPage = 1;
                renderAttachTable();
            });
            
            // Setup Toggle Switch Listeners for Configuration (Optional Mock)
            document.querySelectorAll('.toggle-checkbox').forEach(toggle => {
                toggle.addEventListener('change', (e) => {
                    // Visual feedback handled by CSS, logic can be added here
                    console.log('Toggle changed:', e.target.checked);
                });
            });

            const configContainer = document.getElementById('view-config');
            if (configContainer) {
                configContainer.querySelectorAll('input, select, textarea').forEach((el) => {
                    el.addEventListener('input', markConfigDirty);
                    el.addEventListener('change', markConfigDirty);
                });
            }
            initialConfigFormSnapshot = getConfigFormSnapshot();
        }

        window.addEventListener('pagehide', () => {
            if (!returnSyncSent) {
                returnSyncSent = saveConfig(true);
                if (!returnSyncSent && pendingReturnSync) {
                    returnSyncSent = emitReturnSyncFromLatest();
                    pendingReturnSync = false;
                }
            }
        });
    </script>
</body>
</html>
